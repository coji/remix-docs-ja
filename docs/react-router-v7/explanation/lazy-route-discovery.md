---
title: 遅延ルートディスカバリ
---

# 遅延ルートディスカバリ

[MODES: framework]

<br/>
<br/>

遅延ルートディスカバリは、完全なルートマニフェストを事前にロードするのではなく、ユーザーがアプリケーション内を移動するにつれてルート情報を段階的にロードするパフォーマンス最適化です。

遅延ルートディスカバリが有効になっている場合（デフォルト）、React Routerは、初期のサーバーサイドレンダリングに必要なルートのみをマニフェストで送信します。ユーザーがアプリケーションの新しい部分に移動すると、追加のルート情報が動的にフェッチされ、クライアントサイドのマニフェストに追加されます。

ルートマニフェストには、ルートに関するメタデータ（JavaScript/CSSのインポート、ルートに`loaders`/`actions`があるかどうかなど）が含まれますが、実際のルートモジュールの実装は含まれません。これにより、React Routerは不要なルート情報をダウンロードすることなく、アプリケーションの構造を理解できます。

## ルートディスカバリプロセス

ユーザーが現在のマニフェストにない新しいルートに移動すると、次のようになります。

1. **ルートディスカバリリクエスト** - React Routerは内部の`/__manifest`エンドポイントにリクエストを行います
2. **マニフェストパッチ** - サーバーは必要なルート情報で応答します
3. **ルートロード** - React Routerは必要なルートモジュールとデータをロードします
4. **ナビゲーション** - ユーザーは新しいルートに移動します

## イーガーディスカバリ最適化

ナビゲーションのウォーターフォールを防ぐため、React Routerはイーガールートディスカバリを実装しています。現在のページにレンダリングされるすべての[`<Link>`](../api/components/Link)および[`<NavLink>`](../api/components/NavLink)コンポーネントは、サーバーへのバッチリクエストを介して自動的にディスカバリされます。

このディスカバリリクエストは通常、ユーザーがリンクをクリックする前に完了するため、遅延ルートディスカバリが有効になっていても、その後のナビゲーションは同期的に感じられます。

```tsx
// リンクはデフォルトで自動的にディスカバリされます
<Link to="/dashboard">Dashboard</Link>

// 特定のリンクのディスカバリをオプトアウトします
<Link to="/admin" discover="none">Admin</Link>
```

## パフォーマンス上の利点

遅延ルートディスカバリは、いくつかのパフォーマンス改善をもたらします。

- **高速な初期ロード** - 未使用のルートメタデータを除外することで、初期バンドルサイズが小さくなります
- **メモリ使用量の削減** - ルート情報は必要なときにのみロードされます
- **スケーラビリティ** - 数百のルートを持つアプリケーションでは、より大きなメリットが得られます

## 設定

`react-router.config.ts`でルートディスカバリの動作を設定できます。

```tsx filename=react-router.config.ts
export default {
  // デフォルト: /__manifestエンドポイントを使用した遅延ディスカバリ
  routeDiscovery: {
    mode: "lazy",
    manifestPath: "/__manifest",
  },

  // カスタムマニフェストパス (同じドメイン上の複数のアプリに便利)
  routeDiscovery: {
    mode: "lazy",
    manifestPath: "/my-app-manifest",
  },

  // 遅延ディスカバリを無効にする (すべてのルートを最初に含める)
  routeDiscovery: { mode: "initial" },
} satisfies Config;
```

## デプロイに関する考慮事項

遅延ルートディスカバリを使用する場合、デプロイ設定がマニフェストリクエストを適切に処理することを確認してください。

- **ルート処理** - `/__manifest`リクエストがReact Routerハンドラに到達することを確認します
- **CDNキャッシュ** - CDN/エッジキャッシュを使用している場合、マニフェストエンドポイントのキャッシュキーに`version`および`p`クエリパラメータを含めます
- **複数のアプリケーション** - 同じドメインで複数のReact Routerアプリケーションを実行している場合は、カスタムの`manifestPath`を使用します
