---
title: ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒ
---

# ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒ

Remix ã¯ã€[`v2.9.0`][2.9.0] ã§ [`future.unstable_singleFetch`][future-flags] ãƒ•ãƒ©ã‚°ã®èƒŒå¾Œã«ã€Œã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã€([RFC][rfc]) ã®ã‚µãƒãƒ¼ãƒˆã‚’å°å…¥ã—ã¾ã—ãŸã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã“ã®å‹•ä½œã‚’é¸æŠçš„ã«åˆ©ç”¨ã§ãã¾ã™ã€‚ã“ã‚Œã¯ã€Remix v3 ã§ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ãªã‚Šã¾ã™ã€‚

## æ¦‚è¦

ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã‚’æœ‰åŠ¹ã«ã™ã‚‹ã¨ã€Remix ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®é·ç§»æ™‚ã«ã‚µãƒ¼ãƒãƒ¼ã«å¯¾ã—ã¦å˜ä¸€ã® HTTP å‘¼ã³å‡ºã—ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ã“ã‚Œã«å¯¾ã—ã€å¾“æ¥ã¯è¤‡æ•°ã® HTTP å‘¼ã³å‡ºã—ã‚’ä¸¦è¡Œã—ã¦å®Ÿè¡Œã—ã¦ã„ã¾ã—ãŸï¼ˆãƒ­ãƒ¼ãƒ€ãƒ¼ã”ã¨ã« 1 ã¤ï¼‰ã€‚ãƒ­ãƒ¼ãƒ€ãƒ¼ã‹ã‚‰ `Response` ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿”ã—ã¦ã„ã‚‹å ´åˆï¼ˆã¤ã¾ã‚Šã€`json`/`defer`ï¼‰ã€ã‚¢ãƒ—ãƒªã‚³ãƒ¼ãƒ‰ã‚’å¤§å¹…ã«å¤‰æ›´ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã—ã‹ã—ã€ä»¥ä¸‹ã«ç¤ºã™ã€Œç ´å£Šçš„ã€ãªå¤‰æ›´ç‚¹ã«ã¤ã„ã¦ã¯ã€ç‰¹ã«ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã‚„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹/ãƒ˜ãƒƒãƒ€ãƒ¼ã®å‹•ä½œã«é–¢ã™ã‚‹å¤‰æ›´ç‚¹ã«ã¤ã„ã¦ç†è§£ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

### ç ´å£Šçš„å¤‰æ›´ç‚¹

- ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã¯ã€[`turbo-stream`][turbo-stream] ã‚’ä½¿ç”¨ã—ã¦ã€å†…éƒ¨çš„ã«æ–°ã—ã„ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å½¢å¼ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€JSON ã ã‘ã§ãªãã€ã‚ˆã‚Šè¤‡é›‘ãªãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã§ãã¾ã™ã€‚
- `loader` é–¢æ•°ã¨ `action` é–¢æ•°ã‹ã‚‰è¿”ã•ã‚ŒãŸè£¸ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ã€è‡ªå‹•çš„ã« JSON `Response` ã«å¤‰æ›ã•ã‚Œãªããªã‚Šã€ãƒ¯ã‚¤ãƒ¤ãƒ¼ã‚’ä»‹ã—ã¦ãã®ã¾ã¾ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚Œã¾ã™ã€‚
- å‹æ¨è«–ã‚’æœ€ã‚‚æ­£ç¢ºã«ã™ã‚‹ã«ã¯ã€æ¬¡ã® 2 ã¤ã®æ‰‹é †ã‚’å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
  - `tsconfig.json` ã® `compilerOptions.types` é…åˆ—ã®æœ€å¾Œã«ã€`@remix-run/react/future/single-fetch.d.ts` ã‚’è¿½åŠ ã—ã¾ã™ã€‚
  - ãƒ«ãƒ¼ãƒˆã§ `unstable_defineLoader`/`unstable_defineAction` ã‚’ä½¿ç”¨ã—å§‹ã‚ã¾ã™ã€‚
    - ã“ã‚Œã¯æ®µéšçš„ã«è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚ç¾åœ¨ã®çŠ¶æ…‹ã§ã¯ã€å‹æ¨è«–ã¯ã»ã¨ã‚“ã©æ­£ç¢ºã§ã™ã€‚
- `action` ã® `4xx`/`5xx` `Response` ã®å¾Œã®å†æ¤œè¨¼ã¯ã€ã‚ªãƒ—ãƒˆã‚¢ã‚¦ãƒˆã§ã¯ãªãã€ã‚ªãƒ—ãƒˆã‚¤ãƒ³ã«ãªã‚Šã¾ã—ãŸã€‚
- ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹å ´åˆã¯ã€[`headers`][headers] é–¢æ•°ã¯ä½¿ç”¨ã•ã‚Œãšã€ä»£ã‚ã‚Šã«ã€`loader`/`action` é–¢æ•°ã«æ¸¡ã•ã‚Œã‚‹æ–°ã—ã„ `response` ã‚¹ã‚¿ãƒ–ãŒä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
- å¤ã„ `installGlobals()` ãƒãƒªãƒ•ã‚£ãƒ«ã¯ã€ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã§ã¯æ©Ÿèƒ½ã—ã¾ã›ã‚“ã€‚Node 20 ã®ãƒã‚¤ãƒ†ã‚£ãƒ– `fetch` API ã‚’ä½¿ç”¨ã™ã‚‹ã€ã¾ãŸã¯ã‚«ã‚¹ã‚¿ãƒ ã‚µãƒ¼ãƒãƒ¼ã§ `installGlobals({ nativeFetch: true })` ã‚’å‘¼ã³å‡ºã—ã¦ã€[Undici ãƒ™ãƒ¼ã‚¹ã®ãƒãƒªãƒ•ã‚£ãƒ«][undici-polyfill] ã‚’å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

## è©³ç´°

### ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿å½¢å¼

ä»¥å‰ã€Remix ã¯ `JSON.stringify` ã‚’ä½¿ç”¨ã—ã¦ãƒ­ãƒ¼ãƒ€ãƒ¼/ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ¯ã‚¤ãƒ¤ãƒ¼ã‚’ä»‹ã—ã¦ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã—ã¦ã„ã¾ã—ãŸã€‚ãã®ãŸã‚ã€`defer` å¿œç­”ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ãŸã‚ã«ã€ã‚«ã‚¹ã‚¿ãƒ ã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å½¢å¼ã‚’å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚

ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã§ã¯ã€Remix ã¯ [`turbo-stream`][turbo-stream] ã‚’å†…éƒ¨çš„ã«ä½¿ç”¨ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãŒãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ã§ã‚µãƒãƒ¼ãƒˆã•ã‚Œã€JSON ã‚ˆã‚Šã‚‚è¤‡é›‘ãªãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•çš„ã«ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º/ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã§ãã¾ã™ã€‚æ¬¡ã®ãƒ‡ãƒ¼ã‚¿å‹ã¯ã€`turbo-stream` ã‚’ä»‹ã—ã¦ç›´æ¥ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã§ãã¾ã™ã€‚`BigInt`ã€`Date`ã€`Error`ã€`Map`ã€`Promise`ã€`RegExp`ã€`Set`ã€`Symbol`ã€`URL` ã§ã™ã€‚`Error` ã®ã‚µãƒ–ã‚¿ã‚¤ãƒ—ã‚‚ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«åˆ©ç”¨å¯èƒ½ãªã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼ãŒå­˜åœ¨ã™ã‚‹é™ã‚Šã‚µãƒãƒ¼ãƒˆã•ã‚Œã¾ã™ï¼ˆ`SyntaxError`ã€`TypeError` ãªã©ï¼‰ã€‚

ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã‚’æœ‰åŠ¹ã«ã—ãŸã¨ãã«ã€ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã™ã‚‹å¿…è¦ãŒãªã„å ´åˆã‚‚ã‚ã‚Šã¾ã™ã€‚

- âœ… `loader`/`action` é–¢æ•°ã‹ã‚‰è¿”ã•ã‚Œã‚‹ `json` å¿œç­”ã¯ã€å¼•ãç¶šã `JSON.stringify` ã‚’ä½¿ç”¨ã—ã¦ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚Œã¾ã™ã€‚ãã®ãŸã‚ã€`Date` ã‚’è¿”ã™ã¨ã€`useLoaderData`/`useActionData` ã‹ã‚‰ `string` ãŒè¿”ã•ã‚Œã¾ã™ã€‚
- âš ï¸ `defer` ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¾ãŸã¯è£¸ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã—ã¦ã„ã‚‹å ´åˆã¯ã€`turbo-stream` ã‚’ä½¿ç”¨ã—ã¦ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚Œã¾ã™ã€‚ãã®ãŸã‚ã€`Date` ã‚’è¿”ã™ã¨ã€`useLoaderData`/`useActionData` ã‹ã‚‰ `Date` ãŒè¿”ã•ã‚Œã¾ã™ã€‚
  - ç¾åœ¨ã®å‹•ä½œã‚’ç¶­æŒã—ãŸã„å ´åˆã¯ï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚° `defer` å¿œç­”ã‚’é™¤ãï¼‰ã€æ—¢å­˜ã®è£¸ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æˆ»ã‚Šå€¤ã‚’ `json` ã§ãƒ©ãƒƒãƒ—ã™ã‚‹ã ã‘ã§ã™ã€‚

ã“ã‚Œã¯ã€ãƒ¯ã‚¤ãƒ¤ãƒ¼ã‚’ä»‹ã—ã¦ `Promise` ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’é€ä¿¡ã™ã‚‹ãŸã‚ã«ã€`defer` ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒãªããªã£ãŸã“ã¨ã‚‚æ„å‘³ã—ã¾ã™ï¼è£¸ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã« `Promise` ã‚’å«ã‚ã¦ã€`useLoaderData().whatever` ã§å–å¾—ã§ãã¾ã™ã€‚å¿…è¦ã«å¿œã˜ã¦ `Promise` ã‚’ãƒã‚¹ãƒˆã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ãŒã€UX ã«å½±éŸ¿ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã‚’æ¡ç”¨ã—ãŸã‚‰ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã§ `json`/`defer` ã®ä½¿ç”¨ã‚’æ®µéšçš„ã«å»ƒæ­¢ã—ã€ç”Ÿã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã™ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚

### React ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° API

ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨ãƒ‡ãƒ¼ã‚¿ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ä¸€è²«æ€§ã‚’ç¶­æŒã™ã‚‹ãŸã‚ã«ã€`turbo-stream` ã¯ã€åˆæœŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ãƒ‡ãƒ¼ã‚¿ã‚’é€ã‚Šå‡ºã™ãŸã‚ã®å½¢å¼ã¨ã—ã¦ã‚‚ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã¯ã€ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã‚’é¸æŠã™ã‚‹ã¨ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ [`renderToString`][rendertostring] ã‚’ä½¿ç”¨ã§ããªããªã‚Šã€[`renderToPipeableStream`][rendertopipeablestream] ã¾ãŸã¯ [`renderToReadableStream`][rendertoreadablestream] ãªã©ã® React ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ API ã‚’ [`entry.server.tsx`][entry-server] ã§ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚

ã“ã‚Œã¯ã€HTTP å¿œç­”ã‚’ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚`renderToPipeableStream` ã® `onAllReady` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€ã¾ãŸã¯ `renderToReadableStream` ã® `allReady` ãƒ—ãƒ­ãƒŸã‚¹ã‚’åˆ©ç”¨ã—ã¦ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå…¨ä½“ã‚’ä¸€åº¦ã«é€ä¿¡ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã¯ã€ã“ã‚Œã¯ã€ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒ `Suspense` ãƒã‚¦ãƒ³ãƒ€ãƒªã§ãƒ©ãƒƒãƒ—ã•ã‚Œã¦é…ä¿¡ã•ã‚Œã‚‹ãŸã‚ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã® [`hydrateRoot`][hydrateroot] å‘¼ã³å‡ºã—ã‚’ [`startTransition`][starttransition] å‘¼ã³å‡ºã—ã§ãƒ©ãƒƒãƒ—ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã“ã¨ã‚‚æ„å‘³ã—ã¾ã™ã€‚

### ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

ä»¥å‰ã€Remix ã«ã¯ `ABORT_TIMEOUT` ã®æ¦‚å¿µãŒã‚ã‚Šã€ã“ã‚Œã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã® [`entry.server.tsx`][entry-server] ãƒ•ã‚¡ã‚¤ãƒ«ã«çµ„ã¿è¾¼ã¾ã‚Œã¦ãŠã‚Šã€React ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ã‚’çµ‚äº†ã—ã¦ã„ã¾ã—ãŸãŒã€ä¿ç•™ä¸­ã®é…å»¶ãƒ—ãƒ­ãƒŸã‚¹ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã™ã‚‹ç‰¹åˆ¥ãªã“ã¨ã¯è¡Œã„ã¾ã›ã‚“ã§ã—ãŸã€‚

Remix ãŒå†…éƒ¨çš„ã«ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã™ã‚‹ã‚ˆã†ã«ãªã£ãŸãŸã‚ã€`turbo-stream` ã®å‡¦ç†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã€ä¿ç•™ä¸­ã®ãƒ—ãƒ­ãƒŸã‚¹ã‚’è‡ªå‹•çš„ã«æ‹’å¦ã—ã¦ã€ãã‚Œã‚‰ã®ã‚¨ãƒ©ãƒ¼ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã§ãã¾ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€ã“ã‚Œã¯ 4950 ãƒŸãƒªç§’å¾Œã«ç™ºç”Ÿã—ã¾ã™ã€‚ã“ã‚Œã¯ã€ã»ã¨ã‚“ã©ã® `entry.server.tsx` ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¾åœ¨ã® 5000 ãƒŸãƒªç§’ã® `ABORT_DELAY` ã‚ˆã‚Šã‚‚ã‚ãšã‹ã«çŸ­ã„å€¤ã§ã™ã€‚ã“ã‚Œã¯ã€ãƒ—ãƒ­ãƒŸã‚¹ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦ã€React å´ã‚’ä¸­æ­¢ã™ã‚‹å‰ã«ã€ã‚¨ãƒ©ãƒ¼ã‚’ React ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ã‚’ä»‹ã—ã¦ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã§ã™ã€‚

`entry.server.tsx` ã‹ã‚‰ `streamTimeout` ã®æ•°å€¤ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ã“ã¨ã§ã€ã“ã‚Œã‚’åˆ¶å¾¡ã§ãã¾ã™ã€‚Remix ã¯ã€ã“ã®å€¤ã‚’ãƒŸãƒªç§’å˜ä½ã§ã€`loader`/`action` ã®ä¿ç•™ä¸­ã®ãƒ—ãƒ­ãƒŸã‚¹ã‚’æ‹’å¦ã™ã‚‹ã¾ã§ã®æ™‚é–“ã¨ã—ã¦ä½¿ç”¨ã—ã¾ã™ã€‚ã“ã®å€¤ã¯ã€React ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ã‚’ä¸­æ­¢ã™ã‚‹ã¾ã§ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‹ã‚‰åˆ‡ã‚Šé›¢ã™ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚ã¾ãŸã€React ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’å¸¸ã«é«˜ã„å€¤ã«è¨­å®šã—ã¦ã€`streamTimeout` ã‹ã‚‰ã®åŸºç¤ã¨ãªã‚‹æ‹’å¦ã‚’ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã™ã‚‹æ™‚é–“ã‚’ç¢ºä¿ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```tsx filename=app/entry.server.tsx lines=[1-2,32-33]
// ãƒãƒ³ãƒ‰ãƒ©ãƒ¼é–¢æ•°ã®ä¿ç•™ä¸­ã®ã™ã¹ã¦ã®ãƒ—ãƒ­ãƒŸã‚¹ã‚’ 5 ç§’å¾Œã«æ‹’å¦ã—ã¾ã™
export const streamTimeout = 5000;

// ...

function handleBrowserRequest(
  request: Request,
  responseStatusCode: number,
  responseHeaders: Headers,
  remixContext: EntryContext
) {
  return new Promise((resolve, reject) => {
    const { pipe, abort } = renderToPipeableStream(
      <RemixServer
        context={remixContext}
        url={request.url}
        abortDelay={ABORT_DELAY}
      />,
      {
        onShellReady() {
          /* ... */
        },
        onShellError(error: unknown) {
          /* ... */
        },
        onError(error: unknown) {
          /* ... */
        },
      }
    );

    // React ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ã‚’ 10 ç§’å¾Œã«è‡ªå‹•çš„ã«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã™
    setTimeout(abort, 10000);
  });
}
```

### å‹æ¨è«–

ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒãŒãªã„å ´åˆã€`loader` ã¾ãŸã¯ `action` ã‹ã‚‰è¿”ã•ã‚ŒãŸãƒ—ãƒ¬ãƒ¼ãƒ³ãª JavaScript ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ã€è‡ªå‹•çš„ã« JSON å¿œç­”ã«ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚Œã¾ã™ï¼ˆ`json` ã‚’ä»‹ã—ã¦è¿”ã—ãŸã‹ã®ã‚ˆã†ã«ï¼‰ã€‚å‹æ¨è«–ã¯ã€ã“ã‚ŒãŒå½“ã¦ã¯ã¾ã‚‹ã¨ä»®å®šã—ã€è£¸ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æˆ»ã‚Šå€¤ã‚’ã€JSON ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚ŒãŸã‹ã®ã‚ˆã†ã«æ¨è«–ã—ã¾ã™ã€‚

ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã§ã¯ã€è£¸ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ç›´æ¥ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã•ã‚Œã‚‹ãŸã‚ã€ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã‚’é¸æŠã™ã‚‹ã¨ã€çµ„ã¿è¾¼ã¿ã®å‹æ¨è«–ã¯æ­£ç¢ºã§ã¯ãªããªã‚Šã¾ã™ã€‚ãŸã¨ãˆã°ã€`Date` ã¯ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§æ–‡å­—åˆ—ã«ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚Œã‚‹ã¨ä»®å®šã—ã¾ã™ ğŸ˜•ã€‚

ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã‚’ä½¿ç”¨ã™ã‚‹ã¨ãã«é©åˆ‡ãªå‹ã‚’å–å¾—ã§ãã‚‹ã‚ˆã†ã«ã€`tsconfig.json` ã® `compilerOptions.types` é…åˆ—ã«å«ã‚ã‚‹ã“ã¨ãŒã§ãã‚‹ã€å‹ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã®ã‚»ãƒƒãƒˆãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€å‹ãŒã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã®å‹•ä½œã«åˆã‚ã›ã¦èª¿æ•´ã•ã‚Œã¾ã™ã€‚

```json
{
  "compilerOptions": {
    //...
    "types": [
      // ...
      "@remix-run/react/future/single-fetch.d.ts"
    ]
  }
}
```

ğŸš¨ ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã®å‹ã¯ã€`types` ã®ä»–ã® Remix ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®å¾Œã«é…ç½®ã—ã¦ãã ã•ã„ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€æ—¢å­˜ã®å‹ãŒã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã•ã‚Œã¾ã™ã€‚

#### ãƒ­ãƒ¼ãƒ€ãƒ¼/ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®šç¾©ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£

ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã§ãƒ­ãƒ¼ãƒ€ãƒ¼ã¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®šç¾©ã™ã‚‹ã¨ãã«ã€å‹å®‰å…¨æ€§ã‚’é«˜ã‚ã‚‹ãŸã‚ã«ã€æ–°ã—ã„ `unstable_defineLoader` ã¨ `unstable_defineAction` ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚

```ts
import { unstable_defineLoader as defineLoader } from "@remix-run/node";

export const loader = defineLoader(({ request }) => {
  //                                  ^? Request
});
```

ã“ã‚Œã«ã‚ˆã‚Šã€å¼•æ•°ã®å‹ãŒå¾—ã‚‰ã‚Œã¾ã™ï¼ˆ`LoaderFunctionArgs` ã¯éæ¨å¥¨ã«ãªã‚Šã¾ã™ï¼‰ã€‚ã¾ãŸã€ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã¨äº’æ›æ€§ã®ã‚ã‚‹å‹ã‚’è¿”ã—ã¦ã„ã‚‹ã“ã¨ã‚’ä¿è¨¼ã—ã¾ã™ã€‚

```ts
export const loader = defineLoader(() => {
  return { hello: "world", badData: () => 1 };
  //                       ^^^^^^^ å‹ã‚¨ãƒ©ãƒ¼: `badData` ã¯ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã§ãã¾ã›ã‚“
});

export const action = defineAction(() => {
  return { hello: "world", badData: new CustomType() };
  //                       ^^^^^^^ å‹ã‚¨ãƒ©ãƒ¼: `badData` ã¯ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã§ãã¾ã›ã‚“
});
```

ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã¯ã€æ¬¡ã®æˆ»ã‚Šå€¤å‹ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚

```ts
type Serializable =
  | undefined
  | null
  | boolean
  | string
  | symbol
  | number
  | bigint
  | Date
  | URL
  | RegExp
  | Error
  | Array<Serializable>
  | { [key: PropertyKey]: Serializable } // ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºå¯èƒ½ãªå€¤ã‚’æŒã¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
  | Map<Serializable, Serializable>
  | Set<Serializable>
  | Promise<Serializable>;
```

`defineClientLoader`/`defineClientAction` ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®åŒç­‰ç‰©ã‚‚ã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã‚‰ã¯ã€`clientLoader`/`clientAction` ã‹ã‚‰è¿”ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã¯ãƒ¯ã‚¤ãƒ¤ãƒ¼ã‚’ä»‹ã—ã¦ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã™ã‚‹å¿…è¦ãŒãªã„ãŸã‚ã€åŒã˜æˆ»ã‚Šå€¤ã®åˆ¶é™ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

```ts
import { unstable_defineLoader as defineLoader } from "@remix-run/node";
import { unstable_defineClientLoader as defineClientLoader } from "@remix-run/react";

export const loader = defineLoader(() => {
  return { msg: "Hello!", date: new Date() };
});

export const clientLoader = defineClientLoader(
  async ({ serverLoader }) => {
    const data = await serverLoader<typeof loader>();
    //    ^? { msg: string, date: Date }
    return {
      ...data,
      client: "World!",
    };
  }
);

export default function Component() {
  const data = useLoaderData<typeof clientLoader>();
  //    ^? { msg: string, date: Date, client: string }
}
```

<docs-info>ã“ã‚Œã‚‰ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã¯ã€ä¸»ã« `useLoaderData` ã¨ãã®åŒç­‰ç‰©ã®å‹æ¨è«–ç”¨ã§ã™ã€‚`Response` ã‚’è¿”ã—ã€Remix APIï¼ˆ`useFetcher` ãªã©ï¼‰ã§æ¶ˆè²»ã•ã‚Œãªã„ãƒªã‚½ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒˆãŒã‚ã‚‹å ´åˆã¯ã€é€šå¸¸ã® `loader`/`action` å®šç¾©ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚ã“ã‚Œã‚‰ã®ãƒ«ãƒ¼ãƒˆã‚’ `defineLoader`/`defineAction` ã‚’ä½¿ç”¨ã—ã¦å¤‰æ›ã™ã‚‹ã¨ã€`turbo-stream` ã¯ `Response` ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã§ããªã„ãŸã‚ã€å‹ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™ã€‚</docs-info>

#### `useLoaderData`ã€`useActionData`ã€`useRouteLoaderData`ã€`useFetcher`

ã“ã‚Œã‚‰ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯ã€ã‚³ãƒ¼ãƒ‰ã®å¤‰æ›´ã‚’å¿…è¦ã¨ã—ã¾ã›ã‚“ã€‚ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã®å‹ã‚’è¿½åŠ ã™ã‚‹ã¨ã€ã‚¸ã‚§ãƒãƒªãƒƒã‚¯ãŒæ­£ã—ããƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚Œã¾ã™ã€‚

```ts
export const loader = defineLoader(async () => {
  const data = await fetchSomeData();
  return {
    message: data.message, // <- string
    date: data.date, // <- Date
  };
});

export default function Component() {
  // âŒ ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒä»¥å‰ã¯ã€å‹ã¯ `JSON.stringify` ã‚’ä½¿ç”¨ã—ã¦ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚Œã¦ã„ã¾ã—ãŸ
  const data = useLoaderData<typeof loader>();
  //    ^? { message: string, date: string }

  // âœ… ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã§ã¯ã€å‹ã¯ `turbo-stream` ã‚’ä½¿ç”¨ã—ã¦ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚Œã¾ã™
  const data = useLoaderData<typeof loader>();
  //    ^? { message: string, date: Date }
}
```

#### `useMatches`

`useMatches` ã§ã¯ã€ç‰¹å®šã® `match.data` ã§é©åˆ‡ãªå‹æ¨è«–ã‚’å¾—ã‚‹ãŸã‚ã«ã€æ‰‹å‹•ã§ã‚­ãƒ£ã‚¹ãƒˆã—ã¦ãƒ­ãƒ¼ãƒ€ãƒ¼ã®å‹ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã€`UIMatch` å‹ã‚’ `UIMatch_SingleFetch` ã«ç½®ãæ›ãˆã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```diff
  let matches = useMatches();
- let rootMatch = matches[0] as UIMatch<typeof loader>;
+ let rootMatch = matches[0] as UIMatch_SingleFetch<typeof loader>;
```

#### `meta` é–¢æ•°

`meta` é–¢æ•°ã«ã‚‚ã‚¸ã‚§ãƒãƒªãƒƒã‚¯ãŒå¿…è¦ã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ç¾åœ¨ã®ãƒ«ãƒ¼ãƒˆãƒ­ãƒ¼ãƒ€ãƒ¼å‹ã¨ç¥–å…ˆãƒ«ãƒ¼ãƒˆãƒ­ãƒ¼ãƒ€ãƒ¼å‹ãŒç¤ºã•ã‚Œã€`data` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ `matches` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒé©åˆ‡ã«å‹ä»˜ã‘ã‚‰ã‚Œã¾ã™ã€‚ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã€`MetaArgs` å‹ã‚’ `MetaArgs_SingleFetch` ã«ç½®ãæ›ãˆã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```diff
  export function meta({
    data,
    matches,
- }: MetaArgs<typeof loader, { root: typeof rootLoader }>) {
+ }: MetaArgs_SingleFetch<typeof loader, { root: typeof rootLoader }>) {
    // ...
  }
```

### å†æ¤œè¨¼

ä»¥å‰ã€Remix ã¯ã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®é€ä¿¡çµæœã«é–¢ä¿‚ãªãã€å¸¸ã«ã™ã¹ã¦ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ­ãƒ¼ãƒ€ãƒ¼ã‚’å†æ¤œè¨¼ã—ã¦ã„ã¾ã—ãŸã€‚[`shouldRevalidate`][should-revalidate] ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ«ãƒ¼ãƒˆã”ã¨ã«å†æ¤œè¨¼ã‚’ã‚ªãƒ—ãƒˆã‚¢ã‚¦ãƒˆã§ãã¾ã—ãŸã€‚

ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã§ã¯ã€`action` ãŒ `4xx/5xx` ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã® `Response` ã‚’è¿”ã—ãŸã‚Šã€ã‚¹ãƒ­ãƒ¼ã—ãŸã‚Šã—ãŸå ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ãƒ­ãƒ¼ãƒ€ãƒ¼ã¯å†æ¤œè¨¼ã•ã‚Œã¾ã›ã‚“ã€‚`action` ãŒ `4xx/5xx` ä»¥å¤–ã®å¿œç­”ã‚’è¿”ã—ãŸã‚Šã€ã‚¹ãƒ­ãƒ¼ã—ãŸã‚Šã—ãŸå ´åˆã€å†æ¤œè¨¼ã®å‹•ä½œã¯å¤‰æ›´ã•ã‚Œã¾ã›ã‚“ã€‚ã“ã“ã§ã®ç†ç”±ã¯ã€ã»ã¨ã‚“ã©ã®å ´åˆã€`4xx`/`5xx` å¿œç­”ã‚’è¿”ã™å ´åˆã€å®Ÿéš›ã«ã¯ãƒ‡ãƒ¼ã‚¿ãŒå¤‰æ›´ã•ã‚Œã¦ã„ãªã„ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿ã™ã‚‹å¿…è¦ãŒãªã„ãŸã‚ã§ã™ã€‚

`4xx/5xx` ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å¿œç­”ã®å¾Œã§ã‚‚ãƒ­ãƒ¼ãƒ€ãƒ¼ã‚’å†æ¤œè¨¼ã—ãŸã„å ´åˆã¯ã€[`shouldRevalidate`][should-revalidate] é–¢æ•°ã‹ã‚‰ `true` ã‚’è¿”ã™ã“ã¨ã§ã€ãƒ«ãƒ¼ãƒˆã”ã¨ã«å†æ¤œè¨¼ã‚’ã‚ªãƒ—ãƒˆã‚¤ãƒ³ã§ãã¾ã™ã€‚ã¾ãŸã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã«åŸºã¥ã„ã¦åˆ¤æ–­ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆã¯ã€é–¢æ•°ã«æ–°ã—ã„ `unstable_actionStatus` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒæ¸¡ã•ã‚Œã¾ã™ã€‚

å†æ¤œè¨¼ã¯ã€ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒ HTTP å‘¼ã³å‡ºã—ã® `?_routes` ã‚¯ã‚¨ãƒªæ–‡å­—åˆ—ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦å‡¦ç†ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€å‘¼ã³å‡ºã•ã‚Œã‚‹ãƒ­ãƒ¼ãƒ€ãƒ¼ãŒåˆ¶é™ã•ã‚Œã¾ã™ã€‚ã¤ã¾ã‚Šã€ç´°ã‹ã„å†æ¤œè¨¼ã‚’è¡Œã†å ´åˆã¯ã€è¦æ±‚ã•ã‚ŒãŸãƒ«ãƒ¼ãƒˆã«åŸºã¥ã„ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®åˆ—æŒ™ãŒè¡Œã‚ã‚Œã¾ã™ãŒã€ã™ã¹ã¦ã®æƒ…å ±ã¯ URL ã«å«ã¾ã‚Œã¦ã„ã‚‹ãŸã‚ã€ç‰¹åˆ¥ãª CDN æ§‹æˆã¯å¿…è¦ã‚ã‚Šã¾ã›ã‚“ï¼ˆã“ã‚Œã¯ã€ã‚«ã‚¹ã‚¿ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼ã§è¡Œã‚ã‚ŒãŸå ´åˆã€CDN ãŒ `Vary` ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å°Šé‡ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã§ã™ï¼‰ã€‚

### ãƒ˜ãƒƒãƒ€ãƒ¼

[`headers`][headers] é–¢æ•°ã¯ã€ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹å ´åˆã¯ä½¿ç”¨ã•ã‚Œã¾ã›ã‚“ã€‚
ä»£ã‚ã‚Šã«ã€`loader`/`action` é–¢æ•°ã«ã¯ã€ãã®å®Ÿè¡Œã«å›ºæœ‰ã®å¤‰æ›´å¯èƒ½ãª `ResponseStub` ãŒæ¸¡ã•ã‚Œã¾ã™ã€‚

- HTTP å¿œç­”ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å¤‰æ›´ã™ã‚‹ã«ã¯ã€`status` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç›´æ¥è¨­å®šã—ã¾ã™ã€‚
  - `response.status = 201`
- HTTP å¿œç­”ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¨­å®šã™ã‚‹ã«ã¯ã€æ¨™æº–ã® [`Headers`][mdn-headers] API ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
  - `response.headers.set(name, value)`
  - `response.headers.append(name, value)`
  - `response.headers.delete(name)`

```ts
export const action = defineAction(
  async ({ request, response }) => {
    if (!loggedIn(request)) {
      response.status = 401;
      response.headers.append("Set-Cookie", "foo=bar");
      return { message: "Invalid Submission! " };
    }
    await addItemToDb(request);
    return null;
  }
);
```

ã“ã‚Œã‚‰ã®å¿œç­”ã‚¹ã‚¿ãƒ–ã‚’ã‚¹ãƒ­ãƒ¼ã—ã¦ã€ãƒ­ãƒ¼ãƒ€ãƒ¼ã¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ•ãƒ­ãƒ¼ã‚’çŸ­çµ¡ã•ã›ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

```tsx
export const loader = defineLoader(
  ({ request, response }) => {
    if (shouldRedirectToHome(request)) {
      response.status = 302;
      response.headers.set("Location", "/");
      throw response;
    }
    // ...
  }
);
```

å„ `loader`/`action` ã«ã¯ã€å›ºæœ‰ã® `response` ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒæ¸¡ã•ã‚Œã¾ã™ã€‚ãã®ãŸã‚ã€ä»–ã® `loader`/`action` é–¢æ•°ãŒè¨­å®šã—ãŸå€¤ã‚’è¦‹ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ï¼ˆã“ã‚Œã¯ã€ç«¶åˆçŠ¶æ…‹ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼‰ã€‚çµæœã® HTTP å¿œç­”ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¨ãƒ˜ãƒƒãƒ€ãƒ¼ã¯ã€æ¬¡ã®ã‚ˆã†ã«æ±ºå®šã•ã‚Œã¾ã™ã€‚

- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰
  - ã™ã¹ã¦ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ã‹ã€å€¤ãŒ 300 æœªæº€ã®å ´åˆã€æœ€ã‚‚æ·±ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ãŒ HTTP å¿œç­”ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
  - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ãŒ 300 ä»¥ä¸Šã«è¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€æœ€ã‚‚æµ…ã„ 300 ä»¥ä¸Šã®å€¤ãŒ HTTP å¿œç­”ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
- ãƒ˜ãƒƒãƒ€ãƒ¼
  - Remix ã¯ãƒ˜ãƒƒãƒ€ãƒ¼æ“ä½œã‚’è¿½è·¡ã—ã€ã™ã¹ã¦ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãŒå®Œäº†ã—ãŸå¾Œã«ã€æ–°ã—ã„ `Headers` ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§ãã‚Œã‚‰ã‚’å†ç”Ÿã—ã¾ã™ã€‚
  - ã“ã‚Œã‚‰ã¯ã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒæœ€åˆã«å®Ÿè¡Œã•ã‚Œï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰ã€ãƒ­ãƒ¼ãƒ€ãƒ¼ãŒä¸Šã‹ã‚‰ä¸‹ã«é †ç•ªã«å†ç”Ÿã•ã‚Œã¾ã™ã€‚
  - å­ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã® `headers.set` ã¯ã€è¦ªãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®å€¤ã‚’ä¸Šæ›¸ãã—ã¾ã™ã€‚
  - `headers.append` ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€è¦ªãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã¨å­ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®ä¸¡æ–¹ã‹ã‚‰åŒã˜ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¨­å®šã§ãã¾ã™ã€‚
  - `headers.delete` ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€è¦ªãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã«ã‚ˆã£ã¦è¨­å®šã•ã‚ŒãŸå€¤ã‚’å‰Šé™¤ã§ãã¾ã™ãŒã€å­ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã«ã‚ˆã£ã¦è¨­å®šã•ã‚ŒãŸå€¤ã¯å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚

ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã¯ã€è£¸ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æˆ»ã‚Šå€¤ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ãŠã‚Šã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹/ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¨­å®šã™ã‚‹ãŸã‚ã« `Response` ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿”ã™å¿…è¦ãŒãªããªã£ãŸãŸã‚ã€`json`/`redirect`/`redirectDocument`/`defer` ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã¯ã€ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯éæ¨å¥¨ã¨è¦‹ãªã•ã‚Œã¾ã™ã€‚å¼•ãç¶šãé€šå¸¸ã® `Response` ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿”ã™ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã‚‰ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯ã€`response` ã‚¹ã‚¿ãƒ–ã¨åŒã˜ã‚ˆã†ã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’é©ç”¨ã—ã€ã™ã¹ã¦ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ `headers.set` ã‚’ä½¿ç”¨ã—ã¦é©ç”¨ã—ã¾ã™ï¼ˆè¦ªã®åŒã˜åå‰ã®ãƒ˜ãƒƒãƒ€ãƒ¼å€¤ã‚’ä¸Šæ›¸ãã—ã¾ã™ï¼‰ã€‚ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆã¯ã€`Response` ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿”ã™ã“ã¨ã‹ã‚‰ã€æ–°ã—ã„ `response` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«åˆ‡ã‚Šæ›¿ãˆã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

### ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ­ãƒ¼ãƒ€ãƒ¼

ã‚¢ãƒ—ãƒªã« [`clientLoader`][client-loader] é–¢æ•°ã‚’ä½¿ç”¨ã™ã‚‹ãƒ«ãƒ¼ãƒˆãŒã‚ã‚‹å ´åˆã€ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã®å‹•ä½œã¯ã‚ãšã‹ã«å¤‰æ›´ã•ã‚Œã‚‹ã“ã¨ã«æ³¨æ„ã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚`clientLoader` ã¯ã€ã‚µãƒ¼ãƒãƒ¼ `loader` é–¢æ•°ã®å‘¼ã³å‡ºã—ã‚’ã‚ªãƒ—ãƒˆã‚¢ã‚¦ãƒˆã™ã‚‹æ–¹æ³•ã‚’æä¾›ã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã‚‹ãŸã‚ã€ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒå‘¼ã³å‡ºã—ã§ãã®ã‚µãƒ¼ãƒãƒ¼ãƒ­ãƒ¼ãƒ€ãƒ¼ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã¯æ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚ã—ã‹ã—ã€ã™ã¹ã¦ã®ãƒ­ãƒ¼ãƒ€ãƒ¼ã¯ä¸¦è¡Œã—ã¦å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€ã©ã® `clientLoader` ãŒå®Ÿéš›ã«ã‚µãƒ¼ãƒãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’æ±‚ã‚ã¦ã„ã‚‹ã‹ã‚’çŸ¥ã‚‹ã¾ã§ã€å‘¼ã³å‡ºã—ã‚’å¾…ã¤ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚

ãŸã¨ãˆã°ã€æ¬¡ã® `/a/b/c` ãƒ«ãƒ¼ãƒˆã‚’è€ƒãˆã¦ã¿ã¾ã™ã€‚

```ts
// routes/a.tsx
export function loader() {
  return { data: "A" };
}

// routes/a.b.tsx
export function loader() {
  return { data: "B" };
}

// routes/a.b.c.tsx
export function loader() {
  return { data: "C" };
}

export function clientLoader({ serverLoader }) {
  await doSomeStuff();
  const data = await serverLoader();
  return { data };
}
```

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ `/ -> /a/b/c` ã«ç§»å‹•ã—ãŸå ´åˆã€`a` ã¨ `b` ã®ã‚µãƒ¼ãƒãƒ¼ãƒ­ãƒ¼ãƒ€ãƒ¼ã¨ã€`c` ã® `clientLoader` ã‚’å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®ãƒ­ãƒ¼ãƒ€ãƒ¼ã¯æœ€çµ‚çš„ã«ï¼ˆã¾ãŸã¯æœ€çµ‚çš„ã«ã§ã¯ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼‰ç‹¬è‡ªã®ã‚µãƒ¼ãƒãƒ¼ `loader` ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚`a`/`b` ã® `loader` ã‚’ãƒ•ã‚§ãƒƒãƒã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã¨ãã«ã€`c` ã®ã‚µãƒ¼ãƒãƒ¼ `loader` ã‚’ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒå‘¼ã³å‡ºã—ã«å«ã‚ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã—ã€`c` ãŒå®Ÿéš›ã« `serverLoader` ã‚’å‘¼ã³å‡ºã™ï¼ˆã¾ãŸã¯è¿”ã™ï¼‰ã¾ã§é…ã‚‰ã›ã‚‹ã“ã¨ã‚‚ã§ãã¾ã›ã‚“ï¼ˆã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ãƒ•ã‚©ãƒ¼ãƒ«ãŒç™ºç”Ÿã™ã‚‹ãŸã‚ï¼‰ã€‚

ãã®ãŸã‚ã€`clientLoader` ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸãƒ«ãƒ¼ãƒˆã¯ã€ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã‚’ã‚ªãƒ—ãƒˆã‚¢ã‚¦ãƒˆã—ã€`serverLoader` ã‚’å‘¼ã³å‡ºã™ã¨ã€ãã®ãƒ«ãƒ¼ãƒˆã®ã‚µãƒ¼ãƒãƒ¼ `loader` ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ã€å˜ä¸€ã®ãƒ•ã‚§ãƒƒãƒãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚`clientLoader` ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¦ã„ãªã„ã™ã¹ã¦ã®ãƒ«ãƒ¼ãƒˆã¯ã€å˜ä¸€ã® HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ãƒ•ã‚§ãƒƒãƒã•ã‚Œã¾ã™ã€‚

ãã®ãŸã‚ã€ä¸Šè¨˜ã®ãƒ«ãƒ¼ãƒˆè¨­å®šã§ã¯ã€`/ -> /a/b/c` ã¸ã®ç§»å‹•ã«ã‚ˆã‚Šã€æœ€åˆã«ãƒ«ãƒ¼ãƒˆ `a` ã¨ `b` ã®å˜ä¸€ã®ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒå‘¼ã³å‡ºã—ãŒè¡Œã‚ã‚Œã¾ã™ã€‚

```
GET /a/b/c.data?_routes=routes/a,routes/b
```

ãã®å¾Œã€`c` ãŒ `serverLoader` ã‚’å‘¼ã³å‡ºã™ã¨ã€`c` ã®ã‚µãƒ¼ãƒãƒ¼ãƒ­ãƒ¼ãƒ€ãƒ¼ã®ã¿ã‚’å¯¾è±¡ã¨ã—ãŸç‹¬è‡ªã®å‘¼ã³å‡ºã—ãŒè¡Œã‚ã‚Œã¾ã™ã€‚

```
GET /a/b/c.data?_routes=routes/c
```

### ãƒªã‚½ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒˆ

ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã§ä½¿ç”¨ã•ã‚Œã‚‹æ–°ã—ã„ [ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å½¢å¼][streaming-format] ã®ãŸã‚ã€`loader` é–¢æ•°ã¨ `action` é–¢æ•°ã‹ã‚‰è¿”ã•ã‚ŒãŸç”Ÿã® JavaScript ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ã€`json()` ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’ä½¿ç”¨ã—ã¦è‡ªå‹•çš„ã« `Response` ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«å¤‰æ›ã•ã‚Œãªããªã‚Šã¾ã—ãŸã€‚ä»£ã‚ã‚Šã«ã€ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã§ã¯ã€ä»–ã®ãƒ­ãƒ¼ãƒ€ãƒ¼ãƒ‡ãƒ¼ã‚¿ã¨çµ„ã¿åˆã‚ã•ã‚Œã€`turbo-stream` å¿œç­”ã§ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã•ã‚Œã¾ã™ã€‚

ã“ã‚Œã¯ã€å€‹åˆ¥ã«ãƒ’ãƒƒãƒˆã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ãŠã‚Šã€å¸¸ã« Remix API ã‚’ä»‹ã—ã¦ãƒ’ãƒƒãƒˆã™ã‚‹ã¨ã¯é™ã‚‰ãªã„ [ãƒªã‚½ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒˆ][resource-routes] ã«ã¯èˆˆå‘³æ·±ã„ã‚¸ãƒ¬ãƒ³ãƒã‚’ã‚‚ãŸã‚‰ã—ã¾ã™ã€‚ã¾ãŸã€ä»–ã® HTTP ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆ`fetch`ã€`cURL` ãªã©ï¼‰ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

ãƒªã‚½ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒˆãŒå†…éƒ¨ã® Remix API ã§æ¶ˆè²»ã•ã‚Œã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã‚‹å ´åˆã€ã‚ˆã‚Šè¤‡é›‘ãªæ§‹é€ ï¼ˆ`Date` ã‚„ `Promise` ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãªã©ï¼‰ã‚’ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã§ãã‚‹ã‚ˆã†ã€`turbo-stream` ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’æ´»ç”¨ã—ãŸã„ã¨è€ƒãˆã¾ã™ã€‚ã—ã‹ã—ã€å¤–éƒ¨ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å ´åˆã€ã‚ˆã‚Šç°¡å˜ã«æ¶ˆè²»ã§ãã‚‹ JSON æ§‹é€ ã‚’è¿”ã™ã“ã¨ã‚’å¥½ã‚€ã§ã—ã‚‡ã†ã€‚ãã®ãŸã‚ã€v2 ã§ç”Ÿã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã—ãŸå ´åˆã€ãã®å‹•ä½œã¯ã‚ã„ã¾ã„ã«ãªã‚Šã¾ã™ã€‚`turbo-stream` ã‚„ `json()` ã‚’ä½¿ç”¨ã—ã¦ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã‹ï¼Ÿ

Remix v2 ã§ã¯ã€å¾Œæ–¹äº’æ›æ€§ã‚’å®¹æ˜“ã«ã™ã‚‹ãŸã‚ã«ã€ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã® `future` ãƒ•ãƒ©ã‚°ã®æ¡ç”¨ã‚’å®¹æ˜“ã«ã™ã‚‹ãŸã‚ã«ã€ã“ã‚ŒãŒ Remix API ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚Œã¦ã„ã‚‹ã‹ã€å¤–éƒ¨ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚Œã¦ã„ã‚‹ã‹ã«ã‚ˆã£ã¦å‡¦ç†ã•ã‚Œã¾ã™ã€‚å°†æ¥ã® Remix ã§ã¯ã€ç”Ÿã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å¤–éƒ¨æ¶ˆè²»ã®ãŸã‚ã«ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã—ãŸããªã„å ´åˆã¯ã€ç‹¬è‡ªã® JSON å¿œç­”ã‚’è¿”ã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹å ´åˆã® Remix v2 ã®å‹•ä½œã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚

- `useFetcher` ãªã©ã® Remix API ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å ´åˆã€ç”Ÿã® JavaScript ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ã€é€šå¸¸ã®ãƒ­ãƒ¼ãƒ€ãƒ¼ã¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¨åŒã˜ã‚ˆã†ã«ã€`turbo-stream` å¿œç­”ã¨ã—ã¦è¿”ã•ã‚Œã¾ã™ï¼ˆã“ã‚Œã¯ã€`useFetcher` ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆã« `.data` ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’è¿½åŠ ã™ã‚‹ãŸã‚ã§ã™ï¼‰ã€‚

- `fetch` ã‚„ `cURL` ãªã©ã®å¤–éƒ¨ãƒ„ãƒ¼ãƒ«ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å ´åˆã€v2 ã§ã¯å¾Œæ–¹äº’æ›æ€§ã‚’ç¶­æŒã™ã‚‹ãŸã‚ã«ã€`json()` ã¸ã®è‡ªå‹•å¤‰æ›ãŒå¼•ãç¶šãè¡Œã‚ã‚Œã¾ã™ã€‚

  - Remix ã¯ã€ã“ã®çŠ¶æ³ãŒç™ºç”Ÿã™ã‚‹ã¨ã€éæ¨å¥¨ã®è­¦å‘Šã‚’ãƒ­ã‚°ã«è¨˜éŒ²ã—ã¾ã™ã€‚
  - é©å®œã€å½±éŸ¿ã‚’å—ã‘ã‚‹ãƒªã‚½ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã« `json()` å‘¼ã³å‡ºã—ã‚’è¿½åŠ ã§ãã¾ã™ã€‚
  - ã“ã‚Œã‚‰ã®éæ¨å¥¨ã®è­¦å‘Šã«å¯¾å‡¦ã™ã‚‹ã“ã¨ã§ã€æœ€çµ‚çš„ãª Remix v3 ã¸ã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã‚’ã‚¹ãƒ ãƒ¼ã‚ºã«è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚

  ```tsx filename=app/routes/resource.tsx bad
  export function loader() {
    return {
      message: "My externally-accessed resource route",
    };
  }
  ```

  ```tsx filename=app/routes/resource.tsx good
  import { json } from "@remix-run/react";

  export function loader() {
    return json({
      message: "My externally-accessed resource route",
    });
  }
  ```

æ³¨: ç‰¹å®šã® `Response` ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿”ã™å¿…è¦ãŒã‚ã‚‹å¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªãƒªã‚½ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒˆã«ã¯ã€`defineLoader`/`defineAction` ã‚’ä½¿ç”¨ã—ãªã„ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚ã“ã‚Œã‚‰ã®å ´åˆã¯ã€`loader`/`LoaderFunctionArgs` ã‚’ä½¿ç”¨ã™ã‚‹ã®ãŒæœ€å–„ã§ã™ã€‚

#### å¿œç­”ã‚¹ã‚¿ãƒ–ã¨ãƒªã‚½ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒˆ

ä¸Šè¨˜ã®ã‚ˆã†ã«ã€`headers` ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã¯ã€`loader` é–¢æ•°ã¨ `action` é–¢æ•°ã«æ¸¡ã•ã‚Œã‚‹æ–°ã—ã„ [`response` ã‚¹ã‚¿ãƒ–][responsestub] ã«éæ¨å¥¨ã«ãªã‚Šã¾ã—ãŸã€‚ã“ã‚Œã¯ã€ãƒªã‚½ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒˆã§ã¯ã‚„ã‚„æ··ä¹±ã™ã‚‹ç‚¹ãŒã‚ã‚Šã¾ã™ãŒã€å®Ÿéš›ã«ã¯ `Response` ã‚’è¿”ã™ã“ã¨ãŒã§ãã‚‹ãŸã‚ã€ã€Œã‚¹ã‚¿ãƒ–ã€ã®æ¦‚å¿µã¯å®Ÿéš›ã«ã¯å¿…è¦ã‚ã‚Šã¾ã›ã‚“ã€‚ã“ã‚Œã¯ã€è¤‡æ•°ã®ãƒ­ãƒ¼ãƒ€ãƒ¼ã®çµæœã‚’å˜ä¸€ã® Response ã«ãƒãƒ¼ã‚¸ã™ã‚‹å¿…è¦ãŒãªã„ãŸã‚ã§ã™ã€‚

```tsx filename=routes/resource.tsx
// ç‹¬è‡ªã® Response ã‚’ä½¿ç”¨ã™ã‚‹ã®ãŒæœ€ã‚‚ç°¡å˜ãªæ–¹æ³•ã§ã™
export async function loader() {
  const data = await getData();
  return json(data, {
    status: 200,
    headers: {
      "X-Custom": "whatever",
    },
  });
}
```

ä¸€è²«æ€§ã‚’ä¿ã¤ãŸã‚ã«ã€ãƒªã‚½ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒˆã® `loader`/`action` é–¢æ•°ã«ã¯å¼•ãç¶šã `response` ã‚¹ã‚¿ãƒ–ãŒæ¸¡ã•ã‚Œã€å¿…è¦ã«å¿œã˜ã¦ä½¿ç”¨ã§ãã¾ã™ï¼ˆéãƒªã‚½ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼é–“ã§ã‚³ãƒ¼ãƒ‰ã‚’å…±æœ‰ã™ã‚‹å ´åˆãªã©ï¼‰ã€‚

```tsx filename=routes/resource.tsx
// ã—ã‹ã—ã€response ã‚¹ã‚¿ãƒ–ã«å€¤ã‚’è¨­å®šã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™straightforward approach
export async function loader({
  response,
}: LoaderFunctionArgs) {
  const data = await getData();
  response?.status = 200;
  response?.headers.set("X-Custom", "whatever");
  return json(data);
}
```

`response` ã‚¹ã‚¿ãƒ– _ã¨_ ã‚«ã‚¹ã‚¿ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹/ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å‚™ãˆãŸ `Response` ã‚’è¿”ã™ã“ã¨ã¯é¿ã‘ã‚‹ã®ãŒæœ€å–„ã§ã™ãŒã€å®Ÿéš›ã«ãã‚Œã‚’è¡Œã†å ´åˆã¯ã€æ¬¡ã®ãƒ­ã‚¸ãƒƒã‚¯ãŒé©ç”¨ã•ã‚Œã¾ã™ã€‚

- `Response` ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯ã€`response` ã‚¹ã‚¿ãƒ–ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚ˆã‚Šã‚‚å„ªå…ˆã•ã‚Œã¾ã™ã€‚
- `response` ã‚¹ã‚¿ãƒ–ã® `headers` ã®ãƒ˜ãƒƒãƒ€ãƒ¼æ“ä½œã¯ã€è¿”ã•ã‚ŒãŸ `Response` ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§å†ç”Ÿã•ã‚Œã¾ã™ã€‚

### ãƒ•ã‚§ãƒƒãƒãƒãƒªãƒ•ã‚£ãƒ«

ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã§ã¯ã€[`undici`][undici] ã‚’ `fetch` ãƒãƒªãƒ•ã‚£ãƒ«ã¨ã—ã¦ä½¿ç”¨ã™ã‚‹ã€ã¾ãŸã¯ Node 20 ä»¥é™ã§çµ„ã¿è¾¼ã¿ã® `fetch` ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯ã€`@remix-run/web-fetch` ãƒãƒªãƒ•ã‚£ãƒ«ã«ã¯ãªã„ API ã«ä¾å­˜ã—ã¦ã„ã‚‹ãŸã‚ã§ã™ã€‚è©³ç´°ã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã® 2.9.0 ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã® [Undici][undici-polyfill] ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

- ç‹¬è‡ªã®ã‚µãƒ¼ãƒãƒ¼ã‚’ç®¡ç†ã—ã¦ `installGlobals()` ã‚’å‘¼ã³å‡ºã—ã¦ã„ã‚‹å ´åˆã¯ã€ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã‚’ä½¿ç”¨ã™ã‚‹ã¨ãã«ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãªã„ã‚ˆã†ã«ã€`installGlobals({ nativeFetch: true })` ã‚’å‘¼ã³å‡ºã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
- `remix-serve` ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã¯ã€ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ã¨ã€è‡ªå‹•çš„ã« `undici` ãŒä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

### ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

`<RemixServer>` ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ã™ã‚‹ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ã¾ã™ã€‚[ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼][csp] ã‚’ [ãƒãƒ³ã‚¹ã‚½ãƒ¼ã‚¹][csp-nonce] ã§ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã¯ã€`<RemixServer nonce>` ã‚’ä½¿ç”¨ã—ã¦ã€ãƒãƒ³ã‚¹ã‚’ã“ã‚Œã‚‰ã® `<script>` ã‚¿ã‚°ã«æ¸¡ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

[future-flags]: ../file-conventions/remix-config#future
[should-revalidate]: ../route/should-revalidate
[entry-server]: ../file-conventions/entry.server
[client-loader]: ../route/client-loader
[2.9.0]: https://github.com/remix-run/remix/blob/main/CHANGELOG.md#v290
[rfc]: https://github.com/remix-run/remix/discussions/7640
[turbo-stream]: https://github.com/jacob-ebey/turbo-stream
[rendertopipeablestream]: https://react.dev/reference/react-dom/server/renderToPipeableStream
[rendertoreadablestream]: https://react.dev/reference/react-dom/server/renderToReadableStream
[rendertostring]: https://react.dev/reference/react-dom/server/renderToString
[hydrateroot]: https://react.dev/reference/react-dom/client/hydrateRoot
[starttransition]: https://react.dev/reference/react/startTransition
[headers]: ../route/headers
[mdn-headers]: https://developer.mozilla.org/en-US/docs/Web/API/Headers
[resource-routes]: ../guides/resource-routes
[responsestub]: #headers
[streaming-format]: #streaming-data-format
[undici-polyfill]: https://github.com/remix-run/remix/blob/main/CHANGELOG.md#undici
[undici]: https://github.com/nodejs/undici
[csp]: https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/script-src
[csp-nonce]: https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/Sources#sources
