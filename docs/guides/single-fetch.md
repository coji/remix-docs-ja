---
title: ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒ
---

# ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒ

<docs-warning>ã“ã®APIã¯ä¸å®‰å®šã§ä»Šå¾Œã‚‚å¤‰æ›´ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚æœ¬ç•ªç’°å¢ƒã§ã®æ¡ç”¨ã¯é¿ã‘ã¦ãã ã•ã„</docs-warning>

ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã¯æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰æˆ¦ç•¥ã¨ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§ã™ã€‚ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã‚’æœ‰åŠ¹ã«ã™ã‚‹ã¨ã€Remixã¯é€šå¸¸ã®ã‚ˆã†ã«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã”ã¨ã«å€‹åˆ¥ã®HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã†ã®ã§ã¯ãªãã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®é·ç§»æ™‚ã«å˜ä¸€ã®HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã„ã¾ã™ã€‚ã•ã‚‰ã«ã€ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã§ã¯ãƒ­ãƒ¼ãƒ€ãƒ¼ã‚„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ç”Ÿã®(ã‚·ãƒªã‚¢ãƒ«åŒ–ã•ã‚Œã¦ã„ãªã„)ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€ä¾‹ãˆã°`Date`ã€`Error`ã€`Promise`ã€`RegExp`ãªã©ã‚’è¿”ã›ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

## ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã®æœ‰åŠ¹åŒ–

Remix ã¯ [`future.unstable_singleFetch`][future-flags] ãƒ•ãƒ©ã‚°ã‚’ä½¿ã£ã¦ã€[`v2.9.0`][2.9.0]ã‹ã‚‰ã“ã® "ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒ" ([RFC][rfc])ã‚’å°å…¥ã—ã€ã“ã®å‹•ä½œã‚’é¸æŠã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã¯ã‚„ãŒã¦[React Router v7][merging-remix-and-rr]ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ãªã‚‹äºˆå®šã§ã™ã€‚

ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã®æœ‰åŠ¹åŒ–ã¯éå¸¸ã«ç°¡å˜ã§ã™ã€‚ç¾åœ¨ãƒ­ãƒ¼ãƒ€ãƒ¼ã‹ã‚‰`Response`ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿”ã—ã¦ã„ã‚‹ (ã¤ã¾ã‚Š`json`/`defer`ã‚’ä½¿ã£ã¦ã„ã‚‹) å ´åˆã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã«ã»ã¨ã‚“ã©å¤‰æ›´ã‚’åŠ ãˆã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€ä»¥ä¸‹ã® "breaking" å¤‰æ›´ã«ã¤ã„ã¦çŸ¥ã£ã¦ãŠã„ã¦ãã ã•ã„ - ç‰¹ã«ã‚·ãƒªã‚¢ãƒ«åŒ–ã‚„çŠ¶æ…‹/ãƒ˜ãƒƒãƒ€ãƒ¼ã®å‹•ä½œã«é–¢ã™ã‚‹å¤‰æ›´ã§ã™ã€‚

**1. ãƒ•ãƒ¥ãƒ¼ãƒãƒ£ãƒ¼ãƒ•ãƒ©ã‚°ã‚’æœ‰åŠ¹åŒ–**

```diff
  remix({
    future: {
      // ...
+     unstable_singleFetch: true,
    },
  }),
```

**2. `installGlobals`ã‚’æ›´æ–°ã¾ãŸã¯å‰Šé™¤**

ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã§ã¯ã€`fetch`ãƒãƒªãƒ•ã‚£ãƒ«ã¨ã—ã¦[`undici`][undici]ã‚’ä½¿ã†å¿…è¦ãŒã‚ã‚‹ã‹ã€Node 20ä»¥é™ã®çµ„ã¿è¾¼ã¿`fetch`ã‚’ä½¿ã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯ã€`@remix-run/web-fetch`ãƒãƒªãƒ•ã‚£ãƒ«ã«ãªã„ API ã«ä¾å­˜ã—ã¦ã„ã‚‹ãŸã‚ã§ã™ã€‚è©³ç´°ã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã®[Undici][undici-polyfill]ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã”è¦§ãã ã•ã„ã€‚

- Node 20ä»¥é™ã®å ´åˆã¯`installGlobals()`ã‚’å‰Šé™¤ã—ã€Nodeçµ„ã¿è¾¼ã¿ã®`fetch`ã‚’ä½¿ã£ã¦ãã ã•ã„ (ã“ã‚Œã¯`undici`ã¨åŒã˜ã§ã™)ã€‚

- ç‹¬è‡ªã®ã‚µãƒ¼ãƒãƒ¼ã‚’ä½¿ã£ã¦ã„ã¦`installGlobals()`ã‚’å‘¼ã³å‡ºã—ã¦ã„ã‚‹å ´åˆã¯ã€`installGlobals({ nativeFetch: true })`ã¨å‘¼ã³å‡ºã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

  ```diff
  - installGlobals()
  + installGlobals({ nativeFetch: true })
  ```

- `remix-serve`ã‚’ä½¿ã£ã¦ã„ã‚‹å ´åˆã¯ã€ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒãŒæœ‰åŠ¹ãªæ™‚ã«è‡ªå‹•çš„ã«`undici`ã‚’ä½¿ã„ã¾ã™ã€‚

**3. `renderToString`ã‚’ç½®ãæ›ãˆ**

ã»ã¨ã‚“ã©ã®Remixã‚¢ãƒ—ãƒªã§ã¯ãŠãã‚‰ã`renderToString`ã‚’ä½¿ã£ã¦ã„ãªã„ã¨æ€ã„ã¾ã™ãŒã€`entry.server.tsx`ã§ä½¿ã£ã¦ã„ã‚‹å ´åˆã¯ç¶šãã‚’èª­ã‚“ã§ãã ã•ã„ã€‚ãã‚Œä»¥å¤–ã¯é£›ã°ã—ã¦ãã ã•ã„ã€‚

ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¨ãƒ‡ãƒ¼ã‚¿ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ä¸€è²«æ€§ã‚’ç¶­æŒã™ã‚‹ãŸã‚ã«ã€[`turbo-stream`][turbo-stream]ã‚‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®åˆæœŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã™ã‚‹ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã¯ã€ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã«åˆ‡ã‚Šæ›¿ãˆã‚‹ã¨ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯`renderToString`ã‚’ä½¿ãˆãªããªã‚Šã€[`renderToPipeableStream`][rendertopipeablestream]ã‚„[`renderToReadableStream`][rendertoreadablestream]ãªã©ã®Reactã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼APIã‚’ä½¿ã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚[`entry.server.tsx`][entry-server]

ã“ã‚Œã¯ã€HTTPãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¦ã„ã‚‹ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚`renderToPipeableStream`ã®`onAllReady`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚„`renderToReadableStream`ã®`allReady`ãƒ—ãƒ­ãƒŸã‚¹ã‚’åˆ©ç”¨ã—ã¦ã€ä¸€åº¦ã«ãƒ•ãƒ«æ–‡æ›¸ã‚’é€ä¿¡ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã¯ã€ã‚¹ãƒˆãƒªãƒ¼ãƒ ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒ `Suspense`å¢ƒç•Œã§ãƒ©ãƒƒãƒ—ã•ã‚Œã‚‹ãŸã‚ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã® `hydrateRoot`å‘¼ã³å‡ºã—ã‚’ `startTransition`å‘¼ã³å‡ºã—ã§å›²ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

## ç ´å£Šçš„å¤‰æ›´

å…ˆè¿°ã®ã¨ãŠã‚Šã€ãƒ­ãƒ¼ãƒ€ãƒ¼ã‹ã‚‰`Response`ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿”ã—ã¦ã„ã‚‹ (ã¤ã¾ã‚Š`json`/`defer`ã‚’ä½¿ã£ã¦ã„ã‚‹) å ´åˆã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã«ã»ã¨ã‚“ã©å¤‰æ›´ã‚’åŠ ãˆã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚ˆã‚Šè‰¯ã„å‹æ¨è«–ã‚’å¾—ã¦ã€React Router v7ã«å‚™ãˆã‚‹ã«ã¯ã€[ãƒ«ãƒ¼ãƒˆã‚’ä¸€ã¤ãšã¤ç§»è¡Œ][migration-guide]ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒãŒå°å…¥ã™ã‚‹é‡è¦ãªç ´å£Šçš„å¤‰æ›´ãŒã„ãã¤ã‹ã‚ã‚Šã¾ã™:

- **[æ–°ã—ã„ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ][streaming-format]**: ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã¯ã€å†…éƒ¨ã§[`turbo-stream`][turbo-stream]ã‚’ä½¿ã†æ–°ã—ã„ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ä½¿ç”¨ã—ã¦ãŠã‚Šã€å˜ãªã‚‹JSONã ã‘ã§ãªãã€ã‚ˆã‚Šè¤‡é›‘ãªãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸ
- **è‡ªå‹•ã‚·ãƒªã‚¢ãƒ«åŒ–ã®å»ƒæ­¢**: `loader`ãŠã‚ˆã³`action`é–¢æ•°ã‹ã‚‰è¿”ã•ã‚ŒãŸç”Ÿã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ã€ã‚‚ã¯ãšJSON`Response`ã«è‡ªå‹•çš„ã«å¤‰æ›ã•ã‚Œãšã€ãã®ã¾ã¾ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çµŒç”±ã§é€ä¿¡ã•ã‚Œã¾ã™
- **å‹æ¨è«–ã®æ›´æ–°**: æœ€ã‚‚æ­£ç¢ºãªå‹æ¨è«–ã‚’å¾—ã‚‹ã«ã¯ã€æ¬¡ã®2ã¤ã®ã“ã¨ã‚’è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™:
  - `tsconfig.json`ã®`compilerOptions.types`é…åˆ—ã®æœ«å°¾ã«`@remix-run/react/future/single-fetch.d.ts`ã‚’è¿½åŠ ã™ã‚‹
  - ãƒ«ãƒ¼ãƒˆã§`unstable_defineLoader`/`unstable_defineAction`ã®ä½¿ç”¨ã‚’é–‹å§‹ã™ã‚‹
    - ã“ã‚Œã¯æ®µéšçš„ã«è¡Œãˆã¾ã™ - ç¾åœ¨ã®çŠ¶æ…‹ã§ã‚‚ã€ã»ã¨ã‚“ã©æ­£ç¢ºãªå‹æ¨è«–ãŒå¾—ã‚‰ã‚Œã¾ã™
- [**ã‚ªãƒ—ãƒˆã‚¤ãƒ³`action`ã®å†æ¤œè¨¼**][action-revalidation]: `4xx`/`5xx`ã®`Response`ã‚’è¿”ã™ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å†æ¤œè¨¼ãŒã‚ªãƒ—ãƒˆã‚¢ã‚¦ãƒˆã‹ã‚‰ã‚ªãƒ—ãƒˆã‚¤ãƒ³ã«å¤‰æ›´ã•ã‚Œã¾ã—ãŸ
- **éæ¨å¥¨ã®`headers`ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ**: ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒãŒæœ‰åŠ¹ãªå ´åˆã€ãƒ­ãƒ¼ãƒ€ãƒ¼ã‚„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é–¢æ•°ã«æ¸¡ã•ã‚Œã‚‹æ–°ã—ã„`response`ã‚¹ã‚¿ãƒ–ã«ç½®ãæ›ãˆã‚‰ã‚Œã€[`headers`][headers]é–¢æ•°ã¯ä½¿ç”¨ã•ã‚Œãªããªã‚Šã¾ã—ãŸ
- **éæ¨å¥¨ã®`fetch`ãƒãƒªãƒ•ã‚£ãƒ«**: ä»¥å‰ã®`installGlobals()`ãƒãƒªãƒ•ã‚£ãƒ«ã¯ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã§ã¯æ©Ÿèƒ½ã—ã¾ã›ã‚“ã€‚ä»£ã‚ã‚Šã«Node 20ã®çµ„ã¿è¾¼ã¿`fetch` APIã‚’ä½¿ã†ã‹ã€[undici ãƒ™ãƒ¼ã‚¹ã®ãƒãƒªãƒ•ã‚£ãƒ«][undici-polyfill]ã‚’ä½¿ã†ãŸã‚ã«`installGlobals({ nativeFetch: true })`ã‚’å‘¼ã³å‡ºã™å¿…è¦ãŒã‚ã‚Šã¾ã™

## ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã‚’ä½¿ã£ãŸæ–°ã—ã„ãƒ«ãƒ¼ãƒˆã®è¿½åŠ 

ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã‚’æœ‰åŠ¹ã«ã™ã‚‹ã¨ã€ã‚ˆã‚Šå¼·åŠ›ãªã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¨`response`ã‚¹ã‚¿ãƒ–ã‚’æ´»ç”¨ã™ã‚‹ãƒ«ãƒ¼ãƒˆã‚’ä½œæˆã§ãã¾ã™ã€‚

<docs-info>é©åˆ‡ãªå‹æ¨è«–ã‚’å¾—ã‚‹ã«ã¯ã€ã¾ãš`tsconfig.json`ã®`compilerOptions.types`é…åˆ—ã®æœ«å°¾ã«`@remix-run/react/future/single-fetch.d.ts`ã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã«ã¤ã„ã¦ã¯[å‹æ¨è«–ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³][type-inference-section]ã§è©³ã—ãèª¬æ˜ã—ã¦ã„ã¾ã™ã€‚</docs-info>

ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã§ã¯ã€ãƒ­ãƒ¼ãƒ€ãƒ¼ã‹ã‚‰æ¬¡ã®ãƒ‡ãƒ¼ã‚¿å‹ã‚’è¿”ã™ã“ã¨ãŒã§ãã¾ã™: `BigInt`ã€`Date`ã€`Error`ã€`Map`ã€`Promise`ã€`RegExp`ã€`Set`ã€`Symbol`ã€`URL`ã€‚

```tsx
// routes/blog.$slug.tsx
import { unstable_defineLoader as defineLoader } from "@remix-run/node";

export const loader = defineLoader(
  async ({ params, response }) => {
    const { slug } = params;

    const comments = fetchComments(slug);
    const blogData = await fetchBlogData(slug);

    response.headers.set("Cache-Control", "max-age=300");

    return {
      content: blogData.content, // <- string
      published: blogData.date, // <- Date
      comments, // <- Promise
    };
  }
);

export default function BlogPost() {
  const blogData = useLoaderData<typeof loader>();
  //    ^? { content: string, published: Date, comments: Promise }

  return (
    <>
      <Header published={blogData.date} />
      <BlogContent content={blogData.content} />
      <Suspense fallback={<CommentsSkeleton />}>
        <Await resolve={blogData.comments}>
          {(comments) => (
            <BlogComments comments={comments} />
          )}
        </Await>
      </Suspense>
    </>
  );
}
```

## ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã¸ã®ç§»è¡Œ

ä»¥ä¸‹ã®å¤‰æ›´ã¯ã€ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã«å¿…è¦ã¨ã„ã†ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ (é–‹å§‹ã™ã‚‹ã«ã¯[ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã®æœ‰åŠ¹åŒ–][start]ã‚’å‚ç…§ã—ã¦ãã ã•ã„)ã€‚ãƒ˜ãƒƒãƒ€ãƒ¼ã‚„ãƒ‡ãƒ¼ã‚¿å‹ã®å¤‰æ›´ã‚’ç¢ºèªã—ã‚„ã™ã„ã‚ˆã†ã«ã€ãƒ«ãƒ¼ãƒˆã”ã¨ã«ã“ã‚Œã‚‰ã®å¤‰æ›´ã‚’è¡Œã†ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚

ã“ã‚Œã‚‰ã®å¤‰æ›´ã‚’è¡Œã†ã“ã¨ã§ã€React Router v7ã¸ã®å††æ»‘ã§ç ´å£Šçš„ã§ã¯ãªã„ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

### å‹æ¨è«–

ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒç„¡ã—ã®å ´åˆã€`loader`ã‚„`action`ã‹ã‚‰è¿”ã•ã‚Œã‚‹ã™ã¹ã¦ã®å˜ç´”Javascriptã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯è‡ªå‹•çš„ã«JSONå¿œç­”ã«ã‚·ãƒªã‚¢ãƒ«åŒ–ã•ã‚Œã¾ã™ (ã‚ãŸã‹ã‚‚`json`ã§è¿”ã—ãŸã‹ã®ã‚ˆã†ã«)ã€‚å‹æ¨è«–ã¯ã“ã®ã‚ˆã†ãªã‚±ãƒ¼ã‚¹ã‚’å‰æã¨ã—ã¦ãŠã‚Šã€ç”Ÿã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®è¿”å´ã‚’ JSON ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚ŒãŸã‚‚ã®ã¨æ¨è«–ã—ã¾ã™ã€‚

ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ç”Ÿã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ç›´æ¥ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã•ã‚Œã‚‹ãŸã‚ã€ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã«åˆ‡ã‚Šæ›¿ãˆãŸå¾Œã®çµ„ã¿è¾¼ã¿ã®å‹æ¨è«–ã¯æ­£ç¢ºã§ã¯ãªããªã‚Šã¾ã™ã€‚ä¾‹ãˆã°ã€`Date`ãŒã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ã¯æ–‡å­—åˆ—ã¨ã—ã¦ã‚·ãƒªã‚¢ãƒ«åŒ–ã•ã‚Œã‚‹ã¨æ¨è«–ã—ã¦ã—ã¾ã„ã¾ã™ ğŸ˜•ã€‚

ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã‚’ä½¿ç”¨ã™ã‚‹éš›ã«é©åˆ‡ãªå‹ã‚’å¾—ã‚‹ãŸã‚ã«ã€`tsconfig.json`ã®`compilerOptions.types`é…åˆ—ã«å‹ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã‚»ãƒƒãƒˆã‚’å«ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã®å‹•ä½œã«åˆã‚ã›ã¦å‹ãŒã‚¢ãƒ©ã‚¤ãƒ³ã•ã‚Œã¾ã™:

```json
{
  "compilerOptions": {
    //...
    "types": [
      // ...
      "@remix-run/react/future/single-fetch.d.ts"
    ]
  }
}
```

ğŸš¨ single-fetchã®å‹ãŒä»–ã®Remixãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®å‹ã‚ˆã‚Šå‰ã«æ¥ã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚ãã†ã—ãªã„ã¨ä¸Šæ›¸ãã•ã‚Œã¾ã›ã‚“ã€‚

#### ãƒ­ãƒ¼ãƒ€ãƒ¼/ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®šç¾©ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£

ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã§ãƒ­ãƒ¼ãƒ€ãƒ¼ã¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®šç¾©ã™ã‚‹éš›ã®ã‚¿ã‚¤ãƒ—ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ã‚’é«˜ã‚ã‚‹ãŸã‚ã«ã€æ–°ã—ã„`unstable_defineLoader`ã¨`unstable_defineAction`ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’ä½¿ã†ã“ã¨ãŒã§ãã¾ã™:

```ts
import { unstable_defineLoader as defineLoader } from "@remix-run/node";

export const loader = defineLoader(({ request }) => {
  //                                  ^? Request
});
```

ã“ã‚Œã«ã‚ˆã‚Šã€å¼•æ•°ã®å‹ãŒå¾—ã‚‰ã‚Œã‚‹ã ã‘ã§ãªãã€ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒå¯¾å¿œã®å‹ã‚’è¿”ã—ã¦ã„ã‚‹ã“ã¨ã‚‚ç¢ºèªã•ã‚Œã¾ã™:

```ts
export const loader = defineLoader(() => {
  return { hello: "world", badData: () => 1 };
  //                       ^^^^^^^ ã‚¨ãƒ©ãƒ¼: `badData`ã¯ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºå¯èƒ½ã§ã¯ã‚ã‚Šã¾ã›ã‚“
});

export const action = defineAction(() => {
  return { hello: "world", badData: new CustomType() };
  //                       ^^^^^^^ ã‚¨ãƒ©ãƒ¼: `badData`ã¯ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºå¯èƒ½ã§ã¯ã‚ã‚Šã¾ã›ã‚“
});
```

ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã§ã‚µãƒãƒ¼ãƒˆã•ã‚Œã‚‹è¿”å´å‹ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã™:

```ts
type Serializable =
  | undefined
  | null
  | boolean
  | string
  | symbol
  | number
  | bigint
  | Date
  | URL
  | RegExp
  | Error
  | Array<Serializable>
  | { [key: PropertyKey]: Serializable } // ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºå¯èƒ½ãªå€¤ã‚’æŒã¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
  | Map<Serializable, Serializable>
  | Set<Serializable>
  | Promise<Serializable>;
```

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®`defineClientLoader`/`defineClientAction`ã«ã‚‚åŒæ§˜ã®æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã™ãŒã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çµŒç”±ã§ã‚·ãƒªã‚¢ãƒ«åŒ–ã™ã‚‹å¿…è¦ãŒãªã„ãŸã‚ã€è¿”ã‚Šå€¤ã®åˆ¶é™ã¯ã‚ã‚Šã¾ã›ã‚“:

```ts
import { unstable_defineLoader as defineLoader } from "@remix-run/node";
import { unstable_defineClientLoader as defineClientLoader } from "@remix-run/react";

export const loader = defineLoader(() => {
  return { msg: "Hello!", date: new Date() };
});

export const clientLoader = defineClientLoader(
  async ({ serverLoader }) => {
    const data = await serverLoader<typeof loader>();
    //    ^? { msg: string, date: Date }
    return {
      ...data,
      client: "World!",
    };
  }
);

export default function Component() {
  const data = useLoaderData<typeof clientLoader>();
  //    ^? { msg: string, date: Date, client: string }
}
```

<docs-info>ã“ã‚Œã‚‰ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã¯ä¸»ã«`useLoaderData`ã¨ãã®ç›¸å½“ç‰©ã®å‹æ¨è«–ã®ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚`Response`ã‚’è¿”ã—ã¦ã„ã‚‹ãƒªã‚½ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒˆã§ã€Remix API(`useFetcher`ãªã©)ã«ã‚ˆã£ã¦æ¶ˆè²»ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€é€šå¸¸ã®`loader`/`action`å®šç¾©ã‚’ç¶šã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã‚‰ã®ãƒ«ãƒ¼ãƒˆã‚’`defineLoader`/`defineAction`ã«å¤‰æ›ã™ã‚‹ã¨ã€`turbo-stream`ãŒResponse ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ã‚·ãƒªã‚¢ãƒ«åŒ–ã§ããªã„ãŸã‚ã€å‹ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™ã€‚</docs-info>

#### `useLoaderData`ã€`useActionData`ã€`useRouteLoaderData`ã€`useFetcher`

ã“ã‚Œã‚‰ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯ã‚³ãƒ¼ãƒ‰ã®å¤‰æ›´ã¯ä¸è¦ã§ã™ - ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã®å‹ã‚’è¿½åŠ ã™ã‚‹ã ã‘ã§ã€æ­£ã—ããƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™:


```ts
export const loader = defineLoader(async () => {
  const data = await fetchSomeData();
  return {
    message: data.message, // <- string
    date: data.date, // <- Date
  };
});

export default function Component() {
  // âŒ ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒå‰ã¯ã€å‹ã¯JSON.stringifyã§ã‚·ãƒªã‚¢ãƒ«åŒ–ã•ã‚Œã¦ã„ã¾ã—ãŸ
  const data = useLoaderData<typeof loader>();
  //    ^? { message: string, date: string }

  // âœ… ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒä½¿ç”¨å¾Œã¯ã€å‹ã¯turbo-streamã§ã‚·ãƒªã‚¢ãƒ«åŒ–ã•ã‚Œã¾ã™
  const data = useLoaderData<typeof loader>();
  //    ^? { message: string, date: Date }
}
```

#### `useMatches`

`useMatches`ã§ã¯ã€ã‚ã‚‹`match.data`ã®å‹æ¨è«–ã‚’å¾—ã‚‹ãŸã‚ã«ã€æ‰‹å‹•ã§ã‚­ãƒ£ã‚¹ãƒˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã‚’ä½¿ã†å ´åˆã¯ã€`UIMatch`å‹ã‚’`UIMatch_SingleFetch`ã«ç½®ãæ›ãˆã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™:

```diff
  let matches = useMatches();
- let rootMatch = matches[0] as UIMatch<typeof loader>;
+ let rootMatch = matches[0] as UIMatch_SingleFetch<typeof loader>;
```

#### `meta`é–¢æ•°

`meta`é–¢æ•°ã§ã¯ã€ç¾åœ¨ã®ãƒ«ãƒ¼ãƒˆã¨ãã®ã²ã„ãå…ˆã®ãƒ«ãƒ¼ãƒˆã®ãƒ­ãƒ¼ãƒ€ãƒ¼å‹ã‚’ç¤ºã™ã‚¸ã‚§ãƒãƒªãƒƒã‚¯ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€`data`ã¨`matches`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’é©åˆ‡ã«å‹ä»˜ã‘ã§ãã¾ã™ã€‚ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã‚’ä½¿ã†å ´åˆã¯ã€`MetaArgs`å‹ã‚’`MetaArgs_SingleFetch`ã«ç½®ãæ›ãˆã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™:

```diff
  export function meta({
    data,
    matches,
- }: MetaArgs<typeof loader, { root: typeof rootLoader }>) {
+ }: MetaArgs_SingleFetch<typeof loader, { root: typeof rootLoader }>) {
    // ...
  }
```

### ãƒ˜ãƒƒãƒ€ãƒ¼

ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒãŒæœ‰åŠ¹ãªå ´åˆã€[`headers`][headers]é–¢æ•°ã¯ä½¿ç”¨ã•ã‚Œãªããªã‚Šã¾ã—ãŸã€‚
ä»£ã‚ã‚Šã«ã€`loader`/`action`é–¢æ•°ã«å›ºæœ‰ã®å¤‰æ›´å¯èƒ½ãª`ResponseStub`ãŒæ¸¡ã•ã‚Œã¾ã™:

- HTTPãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å¤‰æ›´ã™ã‚‹ã«ã¯ã€`status`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ç›´æ¥è¨­å®šã—ã¾ã™:
  - `response.status = 201`
- HTTPãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¨­å®šã™ã‚‹ã«ã¯ã€æ¨™æº–ã® [`Headers`][mdn-headers] APIã‚’ä½¿ã„ã¾ã™:
  - `response.headers.set(name, value)`
  - `response.headers.append(name, value)`
  - `response.headers.delete(name)`

```ts
export const action = defineAction(
  async ({ request, response }) => {
    if (!loggedIn(request)) {
      response.status = 401;
      response.headers.append("Set-Cookie", "foo=bar");
      return { message: "Invalid Submission!" };
    }
    await addItemToDb(request);
    return null;
  }
);
```

ã“ã‚Œã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ã‚¿ãƒ–ã‚’ã‚¹ãƒ­ãƒ¼ã™ã‚‹ã“ã¨ã§ã€ãƒ­ãƒ¼ãƒ€ãƒ¼ã‚„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œãƒ•ãƒ­ãƒ¼ã‚’çŸ­çµ¡ã•ã›ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™:

```tsx
export const loader = defineLoader(
  ({ request, response }) => {
    if (shouldRedirectToHome(request)) {
      response.status = 302;
      response.headers.set("Location", "/");
      throw response;
    }
    // ...
  }
);
```

ãã‚Œãã‚Œã®`loader`/`action`ã«ã¯å›ºæœ‰ã®`response`ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒæ¸¡ã•ã‚Œã‚‹ã®ã§ã€ä»–ã®`loader`/`action`é–¢æ•°ãŒè¨­å®šã—ãŸã‚‚ã®ã‚’è¦‹ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“(ã“ã‚Œã¯ãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ã®åŸå› ã¨ãªã‚Šã¾ã™)ã€‚æœ€çµ‚çš„ãªHTTPãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¨ãƒ˜ãƒƒãƒ€ãƒ¼ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«æ±ºã¾ã‚Šã¾ã™:

- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰
  - ã™ã¹ã¦ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ãŒæœªè¨­å®šã¾ãŸã¯300æœªæº€ã®å ´åˆã¯ã€æœ€ã‚‚æ·±ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ãŒä½¿ç”¨ã•ã‚Œã¾ã™
  - 300ä»¥ä¸Šã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ãŒè¨­å®šã•ã‚ŒãŸå ´åˆã¯ã€æœ€ã‚‚æµ…ã„300ä»¥ä¸Šã®å€¤ãŒä½¿ç”¨ã•ã‚Œã¾ã™
- ãƒ˜ãƒƒãƒ€ãƒ¼
  - Remixã¯ãƒ˜ãƒƒãƒ€ãƒ¼æ“ä½œã‚’è¿½è·¡ã—ã€ã™ã¹ã¦ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼å®Œäº†å¾Œã«æ–°ã—ã„`Headers`ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«å†ç”Ÿã—ã¾ã™
  - ã“ã‚Œã‚‰ã¯é †ç•ªã«å†ç”Ÿã•ã‚Œã¾ã™ - ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã§ã€ãã®å¾Œãƒˆãƒƒãƒ—ãƒ€ã‚¦ãƒ³é †ã«ãƒ­ãƒ¼ãƒ€ãƒ¼
  - ä»»æ„ã®å­ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã§ã®`headers.set`ã¯ã€è¦ªãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®å€¤ã‚’ä¸Šæ›¸ãã—ã¾ã™
  - `headers.append`ã‚’ä½¿ã†ã¨ã€è¦ªã¨å­ã®ä¸¡æ–¹ã‹ã‚‰ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¨­å®šã§ãã¾ã™
  - `headers.delete`ã‚’ä½¿ã†ã¨ã€è¦ªãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã§è¨­å®šã•ã‚ŒãŸå€¤ã¯å‰Šé™¤ã§ãã¾ã™ãŒã€å­ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã§è¨­å®šã•ã‚ŒãŸå€¤ã¯å‰Šé™¤ã§ãã¾ã›ã‚“

ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã¯ç”Ÿã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®è¿”å´ã‚’ã‚µãƒãƒ¼ãƒˆã—ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹/ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¨­å®šã™ã‚‹ãŸã‚ã«`Response`ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿”ã™å¿…è¦ãŒãªããªã£ãŸãŸã‚ã€`json`/`redirect`/`redirectDocument`/`defer`ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã¯ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒä½¿ç”¨æ™‚ã«ã¯éæ¨å¥¨ã¨ã¿ãªã•ã‚Œã¾ã™ã€‚ã“ã‚Œã‚‰ã¯v2ã®æœŸé–“ä¸­ã¯æ®‹ã‚Šã¾ã™ã®ã§ã€ã™ãã«å‰Šé™¤ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æ¬¡ã®ãƒ¡ã‚¸ãƒ£ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã¯æã‚‰ãå‰Šé™¤ã•ã‚Œã‚‹ã¨æ€ã‚ã‚Œã¾ã™ã®ã§ã€ãã®é–“ã«æ®µéšçš„ã«å‰Šé™¤ã™ã‚‹ã®ãŒã‚ˆã„ã§ã—ã‚‡ã†ã€‚

ã“ã‚Œã‚‰ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã¯ Remix v2 ã®æ®‹ã‚Šã®æœŸé–“ä¸­ã‚‚å­˜ç¶šã—ã€å°†æ¥çš„ã«ã¯[`remix-utils`][remix-utils]ã®ã‚ˆã†ãªã‚‚ã®ã«ç§»å‹•ã•ã‚Œã‚‹ã‹ã€ç°¡å˜ã«è‡ªåˆ†ã§å†å®Ÿè£…ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã§ã—ã‚‡ã†ã€‚

v2ã§ã¯ã€é€šå¸¸ã®`Response`ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿”ã—ç¶šã‘ã‚‹ã“ã¨ãŒã§ãã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã¯`response`ã‚¹ã‚¿ãƒ–ã¨åŒã˜ã‚ˆã†ã«é©ç”¨ã•ã‚Œã€ã™ã¹ã¦ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã¯`headers.set`ã§é©ç”¨ã•ã‚Œã¾ã™ - è¦ªã‹ã‚‰åŒåã®ãƒ˜ãƒƒãƒ€ãƒ¼å€¤ã‚’ä¸Šæ›¸ãã—ã¾ã™ã€‚ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆã¯ã€`Response`ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿”ã™ä»£ã‚ã‚Šã«æ–°ã—ã„`response`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã‚Œã‚‰ã®æ©Ÿèƒ½ã‚’æ®µéšçš„ã«æ¡ç”¨ã§ãã‚‹ã‚ˆã†ã«ã€`loader`/`action`é–¢æ•°å…¨ã¦ã‚’`response`ã‚¹ã‚¿ãƒ–ã‚’åˆ©ç”¨ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã™ã‚‹å¿…è¦ã¯ãªãã€ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã‚’æœ‰åŠ¹ã«ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨ãŒç›®æ¨™ã§ã™ã€‚ãã®å¾Œã€å€‹åˆ¥ã®ãƒ«ãƒ¼ãƒˆã‚’æ®µéšçš„ã«æ–°ã—ã„`response`ã‚¹ã‚¿ãƒ–ã‚’åˆ©ç”¨ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã—ã¦ã„ãã“ã¨ãŒã§ãã¾ã™ã€‚

### ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ­ãƒ¼ãƒ€ãƒ¼

ã‚¢ãƒ—ãƒªã«[`clientLoader`][client-loader]æ©Ÿèƒ½ã‚’æŒã¤ãƒ«ãƒ¼ãƒˆãŒã‚ã‚‹å ´åˆã€ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã®å‹•ä½œãŒã‚ãšã‹ã«å¤‰ã‚ã‚‹ã“ã¨ã«æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚`clientLoader`ã¯ã‚µãƒ¼ãƒãƒ¼ã®`loader`é–¢æ•°ã‚’å‘¼ã³å‡ºã•ãšã«ã™ã‚€ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ãŒã€ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã®å‘¼ã³å‡ºã—ã§ã¯ã€ãã® server loader ã‚’å®Ÿè¡Œã™ã‚‹ã®ã¯æ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚ã—ã‹ã—ã€ã™ã¹ã¦ã®ãƒ­ãƒ¼ãƒ€ãƒ¼ã‚’ä¸¦åˆ—ã«å®Ÿè¡Œã—ã€ã©ã®`clientLoader`ãŒå®Ÿéš›ã«ã‚µãƒ¼ãƒãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’è¦æ±‚ã™ã‚‹ã‹ã‚’å¾…ã¤ã‚ã‘ã«ã¯ã„ãã¾ã›ã‚“ã€‚

ä¾‹ãˆã°ã€æ¬¡ã®ã‚ˆã†ãª `/a/b/c` ãƒ«ãƒ¼ãƒˆã‚’è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†:

```ts
// routes/a.tsx
export function loader() {
  return { data: "A" };
}

// routes/a.b.tsx
export function loader() {
  return { data: "B" };
}

// routes/a.b.c.tsx
export function loader() {
  return { data: "C" };
}

export function clientLoader({ serverLoader }) {
  await doSomeStuff();
  const data = await serverLoader();
  return { data };
}
```

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ`/ -> /a/b/c`ã¨é·ç§»ã—ãŸå ´åˆã€`a`ã¨`b`ã®ã‚µãƒ¼ãƒãƒ¼ãƒ­ãƒ¼ãƒ€ãƒ¼ã‚’å®Ÿè¡Œã—ã€`c`ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ­ãƒ¼ãƒ€ãƒ¼ã‚’å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ­ãƒ¼ãƒ€ãƒ¼ã¯æœ€çµ‚çš„ã« (ã‚ã‚‹ã„ã¯æœ€çµ‚çš„ã«ã§ã¯ãªã„) è‡ªèº«ã®ã‚µãƒ¼ãƒãƒ¼ãƒ­ãƒ¼ãƒ€ãƒ¼ã‚’å‘¼ã³å‡ºã™å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã®ã‚³ãƒ¼ãƒ«ã«`c`ã®ã‚µãƒ¼ãƒãƒ¼ãƒ­ãƒ¼ãƒ€ãƒ¼ã‚’å«ã‚ã‚‹ã‹ã€`c`ãŒå®Ÿéš›ã«ã‚µãƒ¼ãƒãƒ¼ãƒ­ãƒ¼ãƒ€ãƒ¼ã®å‘¼ã³å‡ºã— (ã¾ãŸã¯è¿”å´) ã‚’å¾…ã¤ã¾ã§é…å»¶ã•ã›ã‚‹ã‹ã‚’æ±ºã‚ã‚‹ã®ã¯ã€ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ãƒ•ã‚©ãƒ¼ãƒ«ã‚’å°å…¥ã—ã¦ã—ã¾ã†ãŸã‚é›£ã—ã„ã§ã™ã€‚

ã—ãŸãŒã£ã¦ã€`clientLoader`ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ãƒ«ãƒ¼ãƒˆã¯ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã‹ã‚‰å¤–ã‚Œã€`serverLoader`ã‚’å‘¼ã³å‡ºã™éš›ã¯ãã®ãƒ«ãƒ¼ãƒˆã®ã‚µãƒ¼ãƒãƒ¼ãƒ­ãƒ¼ãƒ€ãƒ¼ã®ã¿ã‚’å–å¾—ã™ã‚‹ãŸã‚ã€å˜ä¸€ã®ãƒ•ã‚§ãƒƒãƒã«ãªã‚Šã¾ã™ã€‚`clientLoader`ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¦ã„ãªã„ã™ã¹ã¦ã®ãƒ«ãƒ¼ãƒˆã¯ã€å˜ä¸€ã®HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ãƒ•ã‚§ãƒƒãƒã•ã‚Œã¾ã™ã€‚

ä¸Šè¨˜ã®ãƒ«ãƒ¼ãƒˆè¨­å®šã§`/ -> /a/b/c`ã«é·ç§»ã™ã‚‹ã¨ã€æœ€åˆã«`a`ã¨`b`ã®ãƒ«ãƒ¼ãƒˆã«ã¤ã„ã¦ã®å˜ä¸€ã®ãƒ•ã‚§ãƒƒãƒã‚³ãƒ¼ãƒ«ãŒè¡Œã‚ã‚Œã¾ã™:

```
GET /a/b/c.data?_routes=routes/a,routes/b
```

ãã—ã¦`c`ãŒ`serverLoader`ã‚’å‘¼ã³å‡ºã™ã¨ãã«ã€`c`ã®ã‚µãƒ¼ãƒãƒ¼ãƒ­ãƒ¼ãƒ€ãƒ¼ã«ã¤ã„ã¦ã®å€‹åˆ¥ã®ã‚³ãƒ¼ãƒ«ãŒè¡Œã‚ã‚Œã¾ã™:

```
GET /a/b/c.data?_routes=routes/c
```

### ãƒªã‚½ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒˆ

[ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ][streaming-format]ã®å¤‰æ›´ã«ã‚ˆã‚Šã€`loader`ã¨`action`é–¢æ•°ã‹ã‚‰è¿”ã•ã‚ŒãŸç”Ÿã®JavaScriptã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ã€ã‚‚ã¯ã‚„`json()`ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£çµŒç”±ã§ã®`Response`ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¸ã®è‡ªå‹•å¤‰æ›ã¯è¡Œã‚ã‚Œã¾ã›ã‚“ã€‚ä»£ã‚ã‚Šã«ã€Remix APIã«ã‚ˆã‚‹æ“ç¸¦çš„ãªãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ã§ã¯ã€ä»–ã®ãƒ­ãƒ¼ãƒ€ãƒ¼ãƒ‡ãƒ¼ã‚¿ã¨çµ„ã¿åˆã‚ã•ã‚Œã¦`turbo-stream`ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã•ã‚Œã¾ã™ã€‚

ã“ã‚Œã¯[ãƒªã‚½ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒˆ][resource-routes]ã«å¯¾ã—ã¦èˆˆå‘³æ·±ã„å•é¡Œã‚’æèµ·ã—ã¾ã™ã€‚ãƒªã‚½ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒˆã¯ã€Remix APIã‚’é€šã˜ã¦ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚Œã‚‹ã“ã¨ã‚’å‰æã¨ã—ã¦ã„ãªã„ã‹ã‚‰ã§ã™ã€‚ä»–ã®HTTPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ(`fetch`ã€`cURL`ãªã©)ã‹ã‚‰ã‚‚ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚

ãƒªã‚½ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒˆãŒRemixå†…éƒ¨APIã«ã‚ˆã£ã¦æ¶ˆè²»ã•ã‚Œã‚‹ã“ã¨ã‚’æ„å›³ã—ã¦ã„ã‚‹å ´åˆã€`turbo-stream`ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’æ´»ç”¨ã—ã¦ã€`Date`ã‚„`Promise`ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãªã©ã®è¤‡é›‘ãªæ§‹é€ ã‚’ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ€ã‚¦ãƒ³ã§ãã‚‹ã‚ˆã†ã«ã—ãŸã„ã§ã™ã€‚ä¸€æ–¹ã§ã€å¤–éƒ¨ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚ŒãŸå ´åˆã¯ã€ã‚ˆã‚Šç°¡å˜ã«ä½¿ãˆã‚‹JSONã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ãƒ¼ã‚’è¿”ã—ãŸã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€v2ã§ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç›´æ¥è¿”ã™ã¨ã©ã®ã‚ˆã†ã«æ‰±ã†ã¹ãã‹å¾®å¦™ãªç‚¹ãŒã‚ã‚Šã¾ã™ - `turbo-stream`ã§ã‚·ãƒªã‚¢ãƒ«åŒ–ã™ã‚‹ã¹ãã‹ã€ãã‚Œã¨ã‚‚`json()`ã§ã‚·ãƒªã‚¢ãƒ«åŒ–ã™ã‚‹ã¹ãã‹?

ä¸‹ä½äº’æ›æ€§ã‚’ç¢ºä¿ã—ã€ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã®å°†æ¥ã®ãƒ•ãƒ©ã‚°ã®æ¡ç”¨ã‚’å®¹æ˜“ã«ã™ã‚‹ãŸã‚ã«ã€Remix v2ã§ã¯ã‚¢ã‚¯ã‚»ã‚¹å…ƒ(Remix API or å¤–éƒ¨)ã«ã‚ˆã£ã¦å‹•ä½œãŒå¤‰ã‚ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚ä»Šå¾Œã®Versionã§ã¯ã€ç”Ÿã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ€ã‚¦ãƒ³ã—ãŸããªã„å ´åˆã¯ã€è‡ªåˆ†ã§[JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹][returning-response]ã‚’è¿”ã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

Remix v2ã®ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒæœ‰åŠ¹æ™‚ã®å‹•ä½œã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™:

- Remix API(ä¾‹ãˆã°`useFetcher`)ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å ´åˆã€ç”Ÿã®JavaScriptã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯é€šå¸¸ã®ãƒ­ãƒ¼ãƒ€ãƒ¼ã‚„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¨åŒæ§˜ã«`turbo-stream`ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§è¿”ã•ã‚Œã¾ã™(ã“ã‚Œã¯`useFetcher`ãŒ`.data`ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ä»˜åŠ ã™ã‚‹ãŸã‚ã§ã™)

- `fetch`ã‚„`cURL`ãªã©ã®å¤–éƒ¨ãƒ„ãƒ¼ãƒ«ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å ´åˆã€v2ã®ä¸‹ä½äº’æ›æ€§ã®ãŸã‚ã€å¼•ãç¶šãè‡ªå‹•çš„ã«`json()`ã«å¤‰æ›ã•ã‚Œã¾ã™:

  - ã“ã®å ´åˆã€RemixãŒãƒ‡ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è­¦å‘Šã‚’ãƒ­ã‚°ã«å‡ºã—ã¾ã™
  - ã”éƒ½åˆã®è‰¯ã„æ™‚ã«ã€å½±éŸ¿ã‚’å—ã‘ãŸãƒªã‚½ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒˆã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’`Response`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã™ã‚ˆã†ã«æ›´æ–°ã—ã¦ãã ã•ã„
  - ã“ã‚Œã‚‰ã®ãƒ‡ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è­¦å‘Šã«å¯¾å‡¦ã™ã‚‹ã“ã¨ã§ã€æœ€çµ‚çš„ãªRemix v3ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã®æº–å‚™ãŒæ•´ã„ã¾ã™

  ```tsx filename=app/routes/resource.tsx bad
  export function loader() {
    return {
      message: "My externally-accessed resource route",
    };
  }
  ```

  ```tsx filename=app/routes/resource.tsx good
  export function loader() {
    return Response.json({
      message: "My externally-accessed resource route",
    });
  }
  ```

æ³¨æ„: å¤–éƒ¨ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒˆã§ç‰¹å®šã®`Response`ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿”ã™å¿…è¦ãŒã‚ã‚‹å ´åˆã€`defineLoader`/`defineAction`ã®ä½¿ç”¨ã¯æ¨å¥¨ã•ã‚Œã¾ã›ã‚“ã€‚`loader`/`LoaderFunctionArgs`ã‚’ä½¿ã„ç¶šã‘ã‚‹ã®ãŒãƒ™ã‚¹ãƒˆã§ã™ã€‚

#### Responseã‚¹ã‚¿ãƒ–ã¨ãƒªã‚½ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒˆ

ä¸Šè¿°ã®ã¨ãŠã‚Šã€`headers`ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã¯ã€`loader`ãŠã‚ˆã³`action`é–¢æ•°ã«æ¸¡ã•ã‚Œã‚‹æ–°ã—ã„[`response`ã‚¹ã‚¿ãƒ–][responsestub]ã«ç½®ãæ›ãˆã‚‰ã‚Œã¾ã—ãŸã€‚ãŸã ã—ã€ãƒªã‚½ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒˆã§ã¯å°‘ã—æ··ä¹±ã—ã‚„ã™ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ãªãœãªã‚‰ã€å®Ÿéš›ã®`Response`ã‚’è¿”ã™ã“ã¨ãŒã§ãã‚‹ã®ã§ã€è¤‡æ•°ã®ãƒ­ãƒ¼ãƒ€ãƒ¼ã®çµæœã‚’ãƒãƒ¼ã‚¸ã™ã‚‹å¿…è¦ãŒãªã„ãŸã‚ã€"ã‚¹ã‚¿ãƒ–"ã®æ¦‚å¿µã¯ãã‚Œã»ã©å¿…è¦ã‚ã‚Šã¾ã›ã‚“:

```tsx filename=app/routes/resource.tsx
// è‡ªåˆ†ã§`Response`ã‚’ä½¿ã†ã®ãŒæœ€ã‚‚ç°¡å˜ãªæ–¹æ³•
export async function loader() {
  const data = await getData();
  return Response.json(data, {
    status: 200,
    headers: {
      "X-Custom": "whatever",
    },
  });
}
```

ä¸€è²«æ€§ã‚’ä¿ã¤ãŸã‚ã«ã€ãƒªã‚½ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒˆã®`loader`/`action`é–¢æ•°ã«ã‚‚`response`ã‚¹ã‚¿ãƒ–ãŒæ¸¡ã•ã‚Œã‚‹ã®ã§ã€å¿…è¦ã«å¿œã˜ã¦ãã‚Œã‚’ä½¿ã†ã“ã¨ãŒã§ãã¾ã™(ä¾‹ãˆã°ã€éãƒªã‚½ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒˆã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã¨å…±æœ‰ã™ã‚‹ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚‹å ´åˆãªã©):

```tsx filename=app/routes/resource.tsx
// ã—ã‹ã—ã€`response`ã‚¹ã‚¿ãƒ–ã®å€¤ã‚’è¨­å®šã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™
export async function loader({
  response,
}: LoaderFunctionArgs) {
  const data = await getData();
  response?.status = 200;
  response?.headers.set("X-Custom", "whatever");
  return Response.json(data);
}
```

`response`ã‚¹ã‚¿ãƒ–ã‚’ä½¿ã„ã¤ã¤ã€ã‚«ã‚¹ã‚¿ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹/ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æŒã¤`Response`ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿”ã™ã®ã¯é¿ã‘ã‚‹
çŠ¶æ³ã«ã‚ˆã£ã¦ã¯ä¸å¯é¿ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€ãã‚Œä»¥å¤–ã¯é¿ã‘ã‚‹ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†:

- `Response`ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒã€`response`ã‚¹ã‚¿ãƒ–ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚ˆã‚Šã‚‚å„ªå…ˆã•ã‚Œã¾ã™
- `response`ã‚¹ã‚¿ãƒ–ã®`headers`æ“ä½œã¯ã€è¿”ã•ã‚ŒãŸ`Response`ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«å†é©ç”¨ã•ã‚Œã¾ã™

## è¿½åŠ æƒ…å ±

### ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

ã“ã‚Œã¾ã§ã€Remixã¯`loader`/`action`ãƒ‡ãƒ¼ã‚¿ã‚’ `JSON.stringify`ã—ã¦ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çµŒç”±ã§é€ä¿¡ã—ã¦ã„ã¾ã—ãŸã€‚ã¾ãŸã€`defer`ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ãŸã‚ã«ã€ã‚«ã‚¹ã‚¿ãƒ ã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’å®Ÿè£…ã—ã¦ã„ã¾ã—ãŸã€‚

ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã§ã¯ã€å†…éƒ¨ã§[`turbo-stream`][turbo-stream]ã‚’ä½¿ç”¨ã—ã¦ãŠã‚Šã€ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã®ç›´æ¥ã‚µãƒãƒ¼ãƒˆã‚„ã€JSONã‚’è¶…ãˆãŸè¤‡é›‘ãªãƒ‡ãƒ¼ã‚¿ã®ã‚·ãƒªã‚¢ãƒ«åŒ–/ãƒ‡ã‚·ãƒªã‚¢ãƒ«åŒ–ãŒå¯èƒ½ã«ãªã‚Šã¾ã—ãŸã€‚ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿å‹ã¯ `turbo-stream` ã‚’ä»‹ã—ã¦ç›´æ¥ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã§ãã¾ã™: `BigInt`ã€`Date`ã€`Error`ã€`Map`ã€`Promise`ã€`RegExp`ã€`Set`ã€`Symbol`ã€`URL`ã€‚`Error`ã®ã‚µãƒ–ã‚¿ã‚¤ãƒ—ã‚‚ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§å¤§åŸŸçš„ã«åˆ©ç”¨å¯èƒ½ãªã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãŒã‚ã‚‹é™ã‚Šã€ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¾ã™(`SyntaxError`ã€`TypeError`ãªã©)ã€‚

ã“ã‚Œã«ã‚ˆã‚Šã€ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã‚’æœ‰åŠ¹ã«ã—ãŸæ™‚ç‚¹ã§ã€ç›´ã¡ã«ã‚³ãƒ¼ãƒ‰ã«å¤‰æ›´ãŒå¿…è¦ã«ãªã‚‹ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“:

- âœ… `loader`/`action`é–¢æ•°ã‹ã‚‰è¿”ã•ã‚ŒãŸ`json`ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯ã€ä¾ç„¶ã¨ã—ã¦`JSON.stringify`ã§ã‚·ãƒªã‚¢ãƒ«åŒ–ã•ã‚Œã‚‹ãŸã‚ã€`Date`ã‚’è¿”ã™ã¨`useLoaderData`/`useActionData`ã‹ã‚‰ã¯`string`ãŒå¾—ã‚‰ã‚Œã¾ã™
- âš ï¸ `defer`ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚„ç”Ÿã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã™å ´åˆã¯ã€ä»Šåº¦ã¯`turbo-stream`ã§ã‚·ãƒªã‚¢ãƒ«åŒ–ã•ã‚Œã‚‹ãŸã‚ã€`Date`ã‚’è¿”ã™ã¨`useLoaderData`/`useActionData`ã‹ã‚‰ã¯`Date`ãŒå¾—ã‚‰ã‚Œã¾ã™
  - ç¾åœ¨ã®å‹•ä½œã‚’ç¶­æŒã—ãŸã„å ´åˆ(streaming `defer`ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’é™¤ã)ã€ç”Ÿã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®è¿”å´ã‚’`json`ã§å›²ã‚€ã“ã¨ãŒã§ãã¾ã™

ã“ã‚Œã«ã‚ˆã‚Šã€`Promise`ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çµŒç”±ã§é€ä¿¡ã™ã‚‹ãŸã‚ã«`defer`ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’ä½¿ã†å¿…è¦ãŒãªããªã‚Šã¾ã—ãŸ! ç”Ÿã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã©ã“ã«ã§ã‚‚`Promise`ã‚’å«ã‚ã‚‹ã“ã¨ãŒã§ãã€`useLoaderData().whatever`ã§å–å¾—ã§ãã¾ã™ã€‚å¿…è¦ã«å¿œã˜ã¦`Promise`ã‚’ãƒã‚¹ãƒˆã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ - ãŸã ã—ã€UXã¸ã®å½±éŸ¿ã«æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚

ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã‚’æ¡ç”¨ã—ãŸã‚‰ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã‹ã‚‰`json`/`defer`ã®ä½¿ç”¨ã‚’æ®µéšçš„ã«å‰Šé™¤ã—ã€ç”Ÿã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã™ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚

### ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

ã“ã‚Œã¾ã§Remixã«ã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®[`entry.server.tsx`][entry-server]ãƒ•ã‚¡ã‚¤ãƒ«ã«çµ„ã¿è¾¼ã¾ã‚Œã¦ã„ãŸ`ABORT_TIMEOUT`ã¨ã„ã†æ¦‚å¿µãŒã‚ã‚Šã¾ã—ãŸã€‚ã“ã‚Œã¯Reactãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ã‚’çµ‚äº†ã•ã›ã¾ã™ãŒã€ä¿ç•™ä¸­ã®é…å»¶ãƒ—ãƒ­ãƒŸã‚¹ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã™ã‚‹ãŸã‚ã®ç‰¹åˆ¥ãªå‡¦ç†ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚

RemixãŒã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã‚’å†…éƒ¨ã§è¡Œã†ã‚ˆã†ã«ãªã£ãŸãŸã‚ã€`turbo-stream`å‡¦ç†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã€ä¿ç•™ä¸­ã®ãƒ—ãƒ­ãƒŸã‚¹ã‚’è‡ªå‹•çš„ã«æ‹’å¦ã—ã€ãã‚Œã‚‰ã®æ‹’å¦ã‚’Reactãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ã‚’é€šã˜ã¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã‚¢ãƒƒãƒ—ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€ã“ã‚Œã‚‰ã¯4950mså¾Œã«è¡Œã‚ã‚Œã¾ã™ - ã“ã‚Œã¯ã€Reactã‚µã‚¤ãƒ‰ã®çµ‚äº†å‰ã«ãã‚Œã‚‰ã®æ‹’å¦ã‚’ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã‚¢ãƒƒãƒ—ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€ã»ã¨ã‚“ã©ã®entry.server.tsxãƒ•ã‚¡ã‚¤ãƒ«ã®ç¾åœ¨ã®5000ms `ABORT_DELAY`ã®å°‘ã—ä¸‹ã®å€¤ã«é¸æŠã•ã‚Œã¾ã—ãŸã€‚

`entry.server.tsx`ã‹ã‚‰`streamTimeout`æ•°å€¤å€¤ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ã“ã¨ã§ã€ã“ã®å€¤ã‚’åˆ¶å¾¡ã§ãã¾ã™ã€‚Remixã¯ã€ãƒŸãƒªç§’å˜ä½ã®ã“ã®å€¤ã‚’ä½¿ã£ã¦ã€`loader`/`action`ã‹ã‚‰ã®ä¿ç•™ä¸­ã®ãƒ—ãƒ­ãƒŸã‚¹ã‚’æ‹’å¦ã—ã¾ã™ã€‚Reactãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ã‚’ä¸­æ­¢ã™ã‚‹ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚ˆã‚Šã‚‚é«˜ã„å€¤ã«è¨­å®šã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚

```tsx filename=app/entry.server.tsx lines=[1-2,32-33]
// ãƒãƒ³ãƒ‰ãƒ©ãƒ¼é–¢æ•°ã‹ã‚‰ã®ä¿ç•™ä¸­ã®ãƒ—ãƒ­ãƒŸã‚¹ã‚’5ç§’å¾Œã«æ‹’å¦
export const streamTimeout = 5000;

// ...

function handleBrowserRequest(
  request: Request,
  responseStatusCode: number,
  responseHeaders: Headers,
  remixContext: EntryContext
) {
  return new Promise((resolve, reject) => {
    const { pipe, abort } = renderToPipeableStream(
      <RemixServer
        context={remixContext}
        url={request.url}
        abortDelay={ABORT_DELAY}
      />,
      {
        onShellReady() {
          /* ... */
        },
        onShellError(error: unknown) {
          /* ... */
        },
        onError(error: unknown) {
          /* ... */
        },
      }
    );

    // Reactãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ã‚’10ç§’å¾Œã«è‡ªå‹•çš„ã«ä¸­æ­¢
    setTimeout(abort, 10000);
  });
}
```

### å†æ¤œè¨¼

ã“ã‚Œã¾ã§ã¯ã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®çµæœã«é–¢ã‚ã‚‰ãšã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é€ä¿¡å¾Œã«ã™ã¹ã¦ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ­ãƒ¼ãƒ€ãƒ¼ãŒå†æ¤œè¨¼ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚å€‹åˆ¥ã®ãƒ«ãƒ¼ãƒˆã§ã®å†æ¤œè¨¼ã‚’ã‚ªãƒ—ãƒˆã‚¢ã‚¦ãƒˆã§ãã‚‹`shouldRevalidate`æ©Ÿèƒ½ã‚‚ã‚ã‚Šã¾ã—ãŸã€‚

ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã§ã¯ã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒ`4xx`/`5xx`ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™/æŠ•ã’ãŸå ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯å†æ¤œè¨¼ã¯è¡Œã‚ã‚Œã¾ã›ã‚“ã€‚ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒ`4xx`/`5xx`ä»¥å¤–ã®ã‚‚ã®ã‚’è¿”ã™/æŠ•ã’ãŸå ´åˆã¯ã€å¾“æ¥ã®å†æ¤œè¨¼å‹•ä½œã®ã¾ã¾ã§ã™ã€‚ã“ã‚Œã¯ã€ã»ã¨ã‚“ã©ã®å ´åˆ`4xx`/`5xx`ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™éš›ã¯ã€ãƒ‡ãƒ¼ã‚¿ãŒå¤‰æ›´ã•ã‚Œã¦ã„ãªã„ãŸã‚å†æ¤œè¨¼ã®å¿…è¦ãŒãªã„ã¨è€ƒãˆã‚‰ã‚Œã‚‹ãŸã‚ã§ã™ã€‚

ç‰¹å®šã®ãƒ­ãƒ¼ãƒ€ãƒ¼ã‚’`4xx`/`5xx`ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ¬ã‚¹ãƒãƒ³ã‚¹å¾Œã‚‚å†æ¤œè¨¼ã—ãŸã„å ´åˆã¯ã€[`shouldRevalidate`][should-revalidate]é–¢æ•°ã‹ã‚‰`true`ã‚’è¿”ã™ã“ã¨ã§ã‚ªãƒ—ãƒˆã‚¤ãƒ³ã§ãã¾ã™ã€‚ã¾ãŸã€`unstable_actionStatus`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒæ–°ã—ãè¿½åŠ ã•ã‚Œã¦ãŠã‚Šã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã«åŸºã¥ã„ã¦åˆ¤æ–­ã§ãã¾ã™ã€‚

å†æ¤œè¨¼ã¯`?_routes`ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä»‹ã—ã¦å‡¦ç†ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€fine-grainedãªå†æ¤œè¨¼ã‚’è¡Œã†éš›ã«ãƒ«ãƒ¼ãƒˆãƒ™ãƒ¼ã‚¹ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç•ªå·ãŒå¾—ã‚‰ã‚Œã€CDNã®è¨­å®šã‚’å¤‰æ›´ã™ã‚‹å¿…è¦ã‚‚ãªããªã‚Šã¾ã™(ã‚«ã‚¹ã‚¿ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä½¿ã£ã¦Vary ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å°Šé‡ã™ã‚‹å¿…è¦ãŒã‚ã£ãŸå ´åˆã¨ã¯å¯¾ç…§çš„)ã€‚

### ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

`<RemixServer>`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ã™ã‚‹ãŸã‚ã®ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ã¾ã™ã€‚[ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å†…å®¹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼][csp]ã«[ãƒãƒ³ã‚¹ ã‚½ãƒ¼ã‚¹][csp-nonce]ãŒã‚ã‚‹å ´åˆã¯ã€`<RemixServer nonce>`ã‚’ä½¿ã£ã¦ã“ã‚Œã‚‰ã®`<script>`ã‚¿ã‚°ã«ãƒãƒ³ã‚¹ã‚’æ¸¡ã™ã“ã¨ãŒã§ãã¾ã™ã€‚


[future-flags]: ../file-conventions/remix-config#future
[should-revalidate]: ../route/should-revalidate
[entry-server]: ../file-conventions/entry.server
[client-loader]: ../route/client-loader
[2.9.0]: https://github.com/remix-run/remix/blob/main/CHANGELOG.md#v290
[rfc]: https://github.com/remix-run/remix/discussions/7640
[turbo-stream]: https://github.com/jacob-ebey/turbo-stream
[rendertopipeablestream]: https://react.dev/reference/react-dom/server/renderToPipeableStream
[rendertoreadablestream]: https://react.dev/reference/react-dom/server/renderToReadableStream
[rendertostring]: https://react.dev/reference/react-dom/server/renderToString
[hydrateroot]: https://react.dev/reference/react-dom/client/hydrateRoot
[starttransition]: https://react.dev/reference/react/startTransition
[headers]: ../route/headers
[mdn-headers]: https://developer.mozilla.org/en-US/docs/Web/API/Headers
[resource-routes]: ../guides/resource-routes
[returning-response]: ../route/loader.md#returning-response-instances
[responsestub]: #ãƒ˜ãƒƒãƒ€ãƒ¼
[streaming-format]: #ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
[undici-polyfill]: https://github.com/remix-run/remix/blob/main/CHANGELOG.md#undici
[undici]: https://github.com/nodejs/undici
[csp]: https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/script-src
[csp-nonce]: https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/Sources#sources
[remix-utils]: https://github.com/sergiodxa/remix-utils
[merging-remix-and-rr]: https://remix.run/blog/merging-remix-and-react-router
[migration-guide]: #migrating-a-route-with-single-fetch
[action-revalidation]: #ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
[start]: #ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚§ãƒƒãƒã®æœ‰åŠ¹åŒ–
[type-inference-section]: #å‹æ¨è«–
